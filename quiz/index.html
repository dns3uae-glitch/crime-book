<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ุงุฎุชุจุงุฑ ููุฏุงูู โ ููุงุนุฏ ูุนุงููุฉ ูุณุฑุญ ุงูุฌุฑููุฉ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&amp;display=swap" rel="stylesheet"/>
<style>
:root{
  --gold:#FFD54A;
  --blue:#0a6bff;
}
*{box-sizing:border-box}
html, body {height:100%;margin:0}
body{
  display:flex;flex-direction:column;justify-content:space-between;
  background:radial-gradient(circle at center,#001428 0%,#000 90%);
  color:var(--gold);
  font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  min-height:100vh;overflow-x:hidden;
}
.page{
  flex:1;width:100%;
  transform-style:preserve-3d;perspective:2000px;
  transition:transform 1.2s ease-in-out,box-shadow 1.2s ease-in-out;
  position:relative;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding:28px 14px 0;
}
.page.flip-next{transform-origin:right center;transform:rotateY(-180deg);box-shadow:-30px 0 80px rgba(0,0,0,.5);}
.page.flip-prev{transform-origin:left center;transform:rotateY(180deg);box-shadow:30px 0 80px rgba(0,0,0,.5);}
.page::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(120deg,rgba(0,80,255,.25)0%,rgba(255,255,255,.28)25%,rgba(0,80,255,.25)50%,transparent100%);
  opacity:0;mix-blend-mode:screen;pointer-events:none;transition:opacity .8s ease-in-out;
}
.page.flip-next::after,.page.flip-prev::after{opacity:.75;animation:lightReflection 1.2s ease-in-out;}
@keyframes lightReflection{
  0%{transform:translateX(-100%) rotate(0deg);opacity:0}
  25%{opacity:.85}
  50%{transform:translateX(0%) rotate(15deg);opacity:.95}
  100%{transform:translateX(100%) rotate(0);opacity:0}
}
.chapter-title{
  font-weight:900;
  font-size:clamp(1.6rem,4vw,2.2rem);
  color:var(--gold);
  text-align:center;
  text-shadow:0 0 18px rgba(255,215,0,.4),0 0 25px rgba(255,215,0,.2);
  margin-bottom:4px;
}
.section-title{
  font-weight:800;
  font-size:clamp(1.1rem,3.2vw,1.4rem);
  text-shadow:0 0 14px rgba(255,215,0,.35),0 0 22px rgba(10,107,255,.25);
  margin-bottom:16px;
}
.section{
  display:none;
  min-height:calc(100vh - 140px);
  width:100%;
  display:none;
}
.section.active{display:flex;align-items:center;justify-content:center;animation:fadeIn .35s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.card{
  width:min(1100px,92%);
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,215,0,.4);
  border-radius:16px;
  box-shadow:0 0 25px rgba(10,107,255,.25),inset 0 0 18px rgba(255,215,0,.12);
  color:#ffffff;
  line-height:1.9;
  font-size:1.05rem;
  text-shadow:0 0 8px rgba(0,80,255,.1);
  backdrop-filter: blur(6px);
  overflow:hidden;
}
.card-body{padding:22px}
.card-header{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;
  padding:12px 16px;
  border-bottom:1px solid rgba(255,215,0,.25);
  background:linear-gradient(145deg,rgba(13,26,53,.35),rgba(0,8,20,.35));
}
.header-right{font-weight:900;color:#ffeb9a}
.header-center{font-weight:800}
.header-left{display:flex;align-items:center;gap:8px}
.badge{
  background:linear-gradient(145deg,#0d1a35,#000814);
  border:1px solid rgba(255,215,0,.35);
  color:var(--gold);
  padding:6px 12px;
  border-radius:12px;
  font-weight:800;
  letter-spacing:.3px;
  box-shadow:0 0 16px rgba(10,107,255,.25),inset 0 0 12px rgba(255,215,0,.12);
}

.badge span {
  color: #fff;           /* ุงูููู ุงูุฃุจูุถ ููุฃุฑูุงู */
  font-weight: 900;      /* ุณูู ุงูุฎุท ููุฃุฑูุงู */
}

.timer{font-weight:900;font-size:1.02rem}
.btn{
  background:linear-gradient(145deg,#0d1a35,#000814);
  color:#ffffff;border:1px solid rgba(255,215,0,.4);
  padding:10px 16px;font-size:.98rem;border-radius:12px;cursor:pointer;font-weight:800;letter-spacing:.4px;
  box-shadow:0 0 20px rgba(10,107,255,.25),inset 0 0 14px rgba(255,215,0,.15);
  transition:all .25s ease;
}
.btn:hover{transform:translateY(-2px);color:#fff;box-shadow:0 0 28px rgba(255,215,0,.5),inset 0 0 18px rgba(10,107,255,.25);}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn-ghost{background:transparent}
.start-actions{display:flex;justify-content:center;margin-top:18px}
.q{
  background:rgba(255,255,255,0.04);
  border:1px dashed rgba(255,215,0,.35);
  border-radius:12px;padding:14px 16px;margin:10px 0;
}
.q h4{margin:.2rem 0 .6rem 0;font-size:1.02rem;color:#ffec9c}
.options{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
.opt{
  padding:8px 12px;border-radius:10px;border:1px solid rgba(255,215,0,.35);
  background:rgba(10,107,255,.09);cursor:pointer;font-weight:700;color:#ffffff;
}
.opt:hover{background:rgba(10,107,255,.16)}
.opt.selected{outline:2px solid #FFD54A}
.fill-wrap{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.fill-choice{padding:6px 10px;border:1px solid rgba(255,215,0,.35);border-radius:8px;cursor:pointer;background:rgba(10,107,255,.08);font-weight:700;color:#ffffff}
.fill-choice:hover{background:rgba(10,107,255,.16)}
.blank{display:inline-block;min-width:90px;border-bottom:2px dotted #FFD54A;padding:0 4px;margin:0 6px;color:#ffec9c}
.droppable{display:inline-block;min-width:110px;border-bottom:2px dashed #FFD54A;padding:0 6px;margin:0 6px}
.dnd-bank{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.draggable{
  padding:6px 10px;border:1px solid rgba(255,215,0,.35);border-radius:8px;
  background:rgba(10,107,255,.14);font-weight:800;cursor:grab;color:#ffffff;
}
.draggable:active{cursor:grabbing}
.droppable.over{background:rgba(255,213,74,.1)}
footer{
  width:100%;color:var(--gold);font-size:.95rem;text-align:center;padding:12px 0 16px;
  background:linear-gradient(180deg,#0a1630 0%,#050b18 100%);
  border-top:1px solid rgba(0,120,255,.25);
  box-shadow:inset 0 0 22px rgba(0,120,255,.15),0 0 18px rgba(0,120,255,.12);
  backdrop-filter:blur(6px);margin-top:auto;
}
footer .wrap{display:flex;justify-content:space-between;align-items:center;gap:60px;max-width:820px;margin:0 auto;padding:10px 20px;}
.nav-btn{flex:1}
.result-line{margin:.4rem 0;background:rgba(255,255,255,.04);border:1px solid rgba(255,215,0,.25);padding:10px;border-radius:10px}
.score-bar{height:12px;border-radius:12px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:6px}
.score-bar>span{display:block;height:100%;background:linear-gradient(90deg,#24d26b,#ffd54a);width:0%}
.small{font-size:.95rem;color:#ffec9c}

.question-type {
  font-size: 1.05rem;
  color: var(--gold);
  font-weight: bold;
  text-align: right;
  margin-bottom: 6px;
  border-right: 4px solid var(--gold);
  padding-right: 8px;
}
</style>
</head>
<body>
<audio id="pageFlip" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_62c8f9853d.mp3"></audio>
<audio id="woosh" src="https://cdn.pixabay.com/download/audio/2022/03/16/audio_72cf4ac4ff.mp3"></audio>
<audio id="bgMusic" loop="" src="https://cdn.pixabay.com/download/audio/2023/01/04/audio_e4448e0cdf.mp3?filename=donx27t-look-down-the-basement-true-crime-thriller-loopable-music-132133.mp3"></audio>
<audio id="sndCorrect" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_2e9cf9c85a.mp3?filename=correct-2-46134.mp3"></audio>
<audio id="sndWrong" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_2a4b1b8a2c.mp3?filename=error-126627.mp3"></audio>
<div class="page" id="page">
<div class="chapter-title">๐ ุงุฎุชุจุงุฑ ููุฏุงูู</div>
<div class="section-title">ููุงุนุฏ ูุนุงููุฉ ูุณุฑุญ ุงูุฌุฑููุฉ</div>
<section class="section active" id="start">
<div class="card">
<div class="card-header">
<div class="header-right">ุฌุงูุฒ ูุง ุจุทูุ</div>
<div class="header-center badge">โฑ ุงูููุช ุงููุชุจูู: --:--</div>
<div class="header-left"><span class="small">ุงุถุบุท ุงูุฒุฑ ุจุงูุฃุณูู ููุจุฏุก</span></div>
</div>
<div class="card-body" style="text-align:center">
<div class="headline" style="font-size:clamp(1.4rem,3.6vw,2.2rem);font-weight:900;line-height:1.6">
          ูุฑุญุจูุง ุจู ุฃููุง ุงูุทุงูุจ ุงูุถุงุจุทุ ุงุณุชุนุฏ ูุฎูุถ ุงุฎุชุจุงุฑ ุงูููุฏุงู ูู ูุนุงููุฉ ูุณุฑุญ ุงูุฌุฑููุฉ
        </div>
<p class="small">ุณุชูุงุฌู <b>5 ุณููุงุฑูููุงุช</b> ูุงูุนูุฉ. ูู ูู ุณููุงุฑูู ูุฏูู <b>ุฏูููุฉ ูุงุญุฏุฉ</b> ููุฅุฌุงุจุฉ ุนู <b>10 ุฃุณุฆูุฉ</b> ูุชุฏุฑุฌุฉ ุงูุตุนูุจุฉ.<br/>ููููู ุงูุงูุชูุงู ูุฏูููุง ุนุจุฑ ุฒุฑ <b>ุงูุชุงูู</b> ุฏุงุฎู ุงูุจุทุงูุฉุ ุฃู ุณููุชูู ุงููุธุงู ุชููุงุฆููุง ุนูุฏ ุงูุชูุงุก ุงูููุช.</p>
<div class="start-actions">
<button class="btn" id="btnStart" style="min-width:220px">ุงุจุฏุฃ ุงูุชุญููู</button>
</div>
</div>
</div>
</section>
<section class="section" id="scene">
<div class="card">
<div class="card-header">
<div class="header-right">ุงูุณููุงุฑูู: <span id="scnIndex">-</span> / 5</div>
<div class="header-center badge">โฑ ุงูููุช ุงููุชุจูู: <span id="timer">--:--</span></div>
<div class="header-left"><button class="btn" disabled="" id="btnNextTop">ุงูุชุงูู โฎ</button></div>
</div>
<div class="card-body">
<h3 id="sceneTitle" style="margin-top:0"></h3>
<p class="small" id="sceneText" style="margin-top:6px"></p>
<div id="questions"></div>
</div>
</div>
</section>
<section class="section" id="result">
<div class="card">
<div class="card-header">
<div class="header-right">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</div>
<div class="header-center badge">๐ฏ ุชูุฑูุฑ ุงูุฃุฏุงุก</div>
<div class="header-left"><button class="btn" id="btnRetry">๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button></div>
</div>
<div class="card-body">
<p id="finalMsg"></p>
<div class="score-bar"><span id="scoreFill"></span></div>
<h3 style="margin-top:18px">ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก</h3>
<div id="wrongList"></div>
</div>
</div>
</section>
</div>
<footer>
<div class="wrap">
<button class="btn nav-btn" id="prevPage"> ุงูุณุงุจู</button>
<span>ยฉ ุฃูุงุฏูููุฉ ุดุฑุทุฉ ุงูุดุงุฑูุฉ 2025</span>
<button class="btn nav-btn" id="nextPage">ุงูุชุงูู </button>
</div>
</footer>
<script>
const page = document.getElementById('page');
const pageFlip = document.getElementById('pageFlip');
const woosh = document.getElementById('woosh');
const bgMusic = document.getElementById('bgMusic');
bgMusic.volume = 0.15;
const sndCorrect = document.getElementById('sndCorrect');
const sndWrong = document.getElementById('sndWrong');

const secStart = document.getElementById('start');
const secScene = document.getElementById('scene');
const secResult = document.getElementById('result');

const btnStart = document.getElementById('btnStart');
const btnNextTop = document.getElementById('btnNextTop');
const timerEl = document.getElementById('timer');
const scnIndexEl = document.getElementById('scnIndex');
const sceneTitleEl = document.getElementById('sceneTitle');
const sceneTextEl = document.getElementById('sceneText');
const questionsEl = document.getElementById('questions');
const wrongListEl = document.getElementById('wrongList');
const finalMsgEl = document.getElementById('finalMsg');
const scoreFillEl = document.getElementById('scoreFill');

// โ ุงูุชูุงู ูุนูู ููุตูุญุงุช ุงูุฎุงุฑุฌูุฉ (ูุน ูุคุซุฑ ุงูููุจ)
document.getElementById('prevPage').addEventListener('click', ()=>{
  flipTo('https://dns3uae-glitch.github.io/crime-book/ch3-5/','prev');
});
document.getElementById('nextPage').addEventListener('click', ()=>{
  flipTo('https://dns3uae-glitch.github.io/crime-book/agents/','next');
});

// ๐น ุฏุงูุฉ ุฌุฏูุฏุฉ ุชููู ุจุงูุญุฑูุฉ ุซู ุงูุงูุชูุงู ููุฑุงุจุท
function flipTo(url, dir){
  speechSynthesis.cancel();
  page.classList.add(dir==='next' ? 'flip-next' : 'flip-prev');
  pageFlip.play().catch(()=>{});
  woosh.play().catch(()=>{});
  setTimeout(()=>{ window.location.href = url; }, 1000);
}


const SCENES = [
  { title: "ุงููุนุงููุฉ ุงูุฃูููุฉ ูุฅุซุจุงุช ุงูุญุงูุฉ",
    text: "ุฑุคูุฉ ููุงู ุงููุงูุนุฉ ูุฅุซุจุงุช ุญุงูุชู ููุง ุชุฑูู ุงูุฌุงูู ูุจุงุดุฑุฉุ ูุตู ุงูุฃุดุฎุงุต ูุงูุฃุดูุงุก ูุงูุฃูููุฉ ุฐุงุช ุงูุตูุฉ ุจุงูุญุงุฏุซุ ูุน ูุฑุงุนุงุฉ ุงูุฏูุฉ ุงูุนูููุฉ ูุชุฌููุน ุงูุนูุงุตุฑ ุงูุชู ุชูุดู ููููุฉ ูููุน ุงูุฌุฑููุฉ ูุงูุชูุตู ููุฌุงูู.",
    questions: [
      {type:'dnd', q:'ูุฌุจ ุฅุซุจุงุช ุงูุญุงูุฉ ููุง <span class="droppable" data-answer="ุชุฑู">ุ</span> ุงูุฌุงูู ุงูููุงู ุจุนุฏ ุงุฑุชูุงุจ ุงูุฌุฑููุฉ.', tokens:['ุชุฑู','ุนุฏูู','ูุธูู'], a:'ุชุฑู'},
      {type:'mcq', q:'ุงูููุตูุฏ ุจุงููุนุงููุฉ ูู:', opts:['ุฑุคูุฉ ุงูููุงู ููุท','ุฑุคูุฉ ุงูููุงู ูุฅุซุจุงุช ุญุงูุชู','ุฌูุน ุฃููุงู ุงูุดููุฏ ููุท'], a:1},
      {type:'tof', q:'ุฅุซุจุงุช ุงูุญุงูุฉ ูุดูู ูุตู ุญุงูุฉ ุงูุฃุดุฎุงุต ูุงูุฃุดูุงุก ุงููุฑุชุจุทุฉ ุจุงูุญุงุฏุซ.', a:true},
      {type:'fill', q:'ุงูุชุนุฑูู ุงูุนููู ูููุนุงููุฉ: ูุฌููุนุฉ ุนูููุงุช ุฐุงุช ุฃุณุงููุจ _____.', choices:['ุงุนุชุจุงุทูุฉ','ุนูููุฉ','ูุฒุงุฌูุฉ'], a:'ุนูููุฉ'},
      {type:'mcq', q:'ูู ุฃูุฏุงู ุงููุนุงููุฉ:', opts:['ุฅุฎูุงุก ุงูุฃุฏูุฉ','ุงุณุชุธูุงุฑ ููููุฉ ูููุน ุงูุฌุฑููุฉ','ุชุนุฏูู ูุณุฑุญ ุงูุฌุฑููุฉ'], a:1},
      {type:'tof', q:'ูุง ุญุงุฌุฉ ููุตู ุทุจูุนุฉ ุงูุฃุฑุถ ุฃู ูููุน ุงูููุงู ุนูุฏ ุฅุซุจุงุช ุงูุญุงูุฉ.', a:false},
      {type:'mcq', q:'ููุตู ูุถุน ุงูุฌุซุฉ ูููุงุจุณูุง ูุฃู ุฐูู ูุณุงุนุฏ ูู:', opts:['ุงูุชุณููุฉ','ุชูุฏูุฑ ุฒูู ูููุงู ูููุน ุงูุฌุฑููุฉ','ูุง ุดูุก'], a:1},
      {type:'tof', q:'ุฅุซุจุงุช ุงูุญุงูุฉ ูุง ูุดูู ุชูููู ูุง ุฅุฐุง ูุงู ุงููุฌูู ุนููู ูุงุฏุฑูุง ุนูู ุงูููุงู.', a:false},
      {type:'fill', q:'ููุฑุงุนู ูุตู ุจูุน _____ ูู ุงูููุงู ูุฃููุง ูุฏ ุชุฏู ุนูู ููููุฉ ูููุน ุงูุฌุฑููุฉ.', choices:['ุงูุทูุงุก','ุงูุฏูุงุก','ุงููุงุก'], a:'ุงูุฏูุงุก'},
      {type:'mcq', q:'ูุตู ุงูููุงุจุณ ุงูููุฒูุฉ ูุฏ ูุฏู ุนูู:', opts:['ููุงููุฉ ุญุฏุซุช','ูุง ูุฏู ุนูู ุดูุก','ูุธุงูุฉ ุงูููุงู'], a:0},
    ] },
  { title: "ุฏูุฑ ุงูุดุฑุทุฉ ูู ุงูุญูุงุธ ุนูู ุจุคุฑุฉ ุงูุญุฏุซ",
    text: "ุชูุซู ุจุคุฑุฉ ุงูุญุฏุซ ููุทุฉ ุงูุงูุทูุงู ููู ุงูุฃุฏูุฉุ ุนูู ุงูุดุฑุทุฉ ุณุฑุนุฉ ุงูุงูุชูุงูุ ุงุณุชุฏุนุงุก ุงูุฎุจุฑุงุกุ ููุนุงููุฉ ูุชูุชูุด ุงูููุงูุ ูููุน ุงูุนุจุซ ูุงูุฏุฎูู ุบูุฑ ุงููุตุฑุญ.",
    questions: [
      {type:'dnd', q:'ุชุดูู ุจุคุฑุฉ ุงูุญุฏุซ ููุทุฉ <span class="droppable" data-answer="ุงูุงูุทูุงู">ุ</span> ููุจุญุซ.', tokens:['ุงูุงูุทูุงู','ุงูุฎุชุงู','ุงูุชุดุชูุช'], a:'ุงูุงูุทูุงู'},
      {type:'mcq', q:'ุฃูู ุฅุฌุฑุงุก ูุญูุฑู ููุดุฑุทุฉ:', opts:['ุณุฑุนุฉ ุงูุงูุชูุงู','ุงูุงุชุตุงู ุจุงูุนุงุฆูุฉ','ุฅุบูุงู ุงูููู'], a:0},
      {type:'tof', q:'ุงุณุชุฏุนุงุก ุงูุฎุจุฑุงุก ุฌุฒุก ุฑุฆูุณู ูู ุงูุญูุงุธ ุนูู ูุณุฑุญ ุงูุฌุฑููุฉ.', a:true},
      {type:'fill', q:'ูุฌุจ ููุน ุฏุฎูู _____ ุฅูู ูุณุฑุญ ุงูุฌุฑููุฉ.', choices:['ุงููุงุฑุฉ','ุงููุชุทูููู','ุงููุญูููู'], a:'ุงููุชุทูููู'},
      {type:'mcq', q:'ุงููุญุงูุธุฉ ุนูู ุงููุณุฑุญ ุชุณุงุนุฏ ุนูู:', opts:['ุทูุณ ุงูุฃุฏูุฉ','ุฌูุฏุฉ ุงูุฏููู','ุชุฃุฎูุฑ ุงูุชุญููู'], a:1},
      {type:'tof', q:'ุงูุณูุงุญ ููุฌููุน ุจุงูุฏุฎูู ูุง ูุคุซุฑ ุนูู ุณูุงูุฉ ุงูุขุซุงุฑ.', a:false},
      {type:'mcq', q:'ุนูุฏ ุงููุตูู ูุฌุจ:', opts:['ุชูุฒูุน ุงูุฌูููุฑ','ุชุฃููู ุงูููุงู','ุชุดุบูู ุงูููุณููู'], a:1},
      {type:'tof', q:'ูุฌุจ ุงุณุชุฏุนุงุก ุงูุฎุจุฑุงุก ุงูููุงุณุจูู ูููุน ุงูุญุงุฏุซ.', a:true},
      {type:'fill', q:'ุงูุชุฃููู ูููุน _____ ุงููุชุนูุฏ ุฃู ุงูุนุฑุถู.', choices:['ุงูุนุจุซ','ุงูุชุฌููู','ุงูุชุนููู'], a:'ุงูุนุจุซ'},
      {type:'mcq', q:'ุงูุบุฑุถ ูู ุณุฑุนุฉ ุงูุงูุชูุงู:', opts:['ุงูุชูุงุท ุตูุฑ ุชุฐูุงุฑูุฉ','ุญูุงูุฉ ุงูุฃุฏูุฉ ูุฅููุงุฐ ุงูุฃุฑูุงุญ','ุฒูุงุฏุฉ ุงูุงุฒุฏุญุงู'], a:1},
    ] },
  { title: "ุชุณุฌูู ุงูููุช ูุฃูููุฉ ุณุฑุนุฉ ุงูุงูุชูุงู",
    text: "ุฅุซุจุงุช ุณุงุนุฉ ุงูุฏุฎูู ูููุณุฑุญ ุถุฑูุฑู ูุชูุฏูุฑ ุฒูู ุงุฑุชูุงุจ ุงูุฌุฑููุฉ ููุทุงุจูุฉ ุงูููุงุญุธุงุช ูุญุฑุงุฑุฉ ููุจ ุงูุดุงู ุฃู ุญุงูุฉ ุงูุชูุจุณุ ุงูุณุฑุนุฉ ุชููุฐ ุงูุฃุฑูุงุญ ูุชููุน ุงูุนุจุซ.",
    questions: [
      {type:'dnd', q:'ุณุฑุนุฉ ุงูุงูุชูุงู ูุฏ ุชุคุฏู ุฅูู <span class="droppable" data-answer="ุฅููุงุฐ">ุ</span> ุญูุงุฉ ุงููุตุงุจูู.', tokens:['ุฅููุงุฐ','ุชุฌุงูู','ุชุนุฑูุถ'], a:'ุฅููุงุฐ'},
      {type:'mcq', q:'ุชุณุฌูู ููุช ุงูุฏุฎูู ูุณุงุนุฏ ูู:', opts:['ุงูุฒููุฉ','ุชูุฏูุฑ ุฒูู ุงูุฌุฑููุฉ','ุฅุทุงูุฉ ุงูุชุญููู'], a:1},
      {type:'tof', q:'ูุฌูุฏ ููุจ ุณุงุฎู ูุฏ ูุฏู ุนูู ุญุฏุงุซุฉ ุงููุงูุนุฉ.', a:true},
      {type:'fill', q:'ุญุงูุฉ _____ ุจุงูุฌุซุฉ ูุฏ ุชุณุงุนุฏ ูู ุชูุฏูุฑ ุงูุฒูู.', choices:['ุงูุชูุจุณ','ุงูุฑุงุญุฉ','ุงูุงุณุชุฑุฎุงุก'], a:'ุงูุชูุจุณ'},
      {type:'mcq', q:'ูู ุฃุณุจุงุจ ุงูุณุฑุนุฉ:', opts:['ุงููุจุถ ุงููุจูุฑ ุนูู ุงูุฌุงูู','ุชุดุชูุช ุงููุฑูู','ุฏุฎูู ุงููุชุทูููู'], a:0},
      {type:'tof', q:'ุนุฏู ุชุณุฌูู ุงูููุช ูููุญ ุฏูุฉ ุฃุนูู ููุชูุฑูุฑ.', a:false},
      {type:'mcq', q:'ุงูุณุฑุนุฉ ุชููุน:', opts:['ุงูุนุจุซ ุงููุชุนูุฏ','ุชูุซูู ุงูุฃุฏูุฉ','ุฅููุงุฐ ุงููุฌูู ุนููู'], a:0},
      {type:'tof', q:'ุชุณุฌูู ุงูููุช ุฅุฌุฑุงุก ุดููู ุบูุฑ ููู.', a:false},
      {type:'fill', q:'ุชูุฏูุฑ ุฒูู ุงูุฌุฑููุฉ ูุนุฒุฒ _____ ุงูุดูุงุฏุฉ ูุงุญููุง.', choices:['ุนุจุซ','ุซูุฉ','ููุถู'], a:'ุซูุฉ'},
      {type:'mcq', q:'ุนูุฏ ุงูุนุซูุฑ ุนูู ูุตุงุจ:', opts:['ุชุฃุฌูู ุฅุณุนุงูู','ุชูุฏูู ุงูุฅุณุนุงู ุงููุงุฒู','ุชุฑูู ุญุชู ูุฃุชู ุงูุทุจูุจ ููุท'], a:1},
    ] },
  { title: "ุงูุจุญุซ ุนู ุงูุจูุน ุงูุฏูููุฉ ูุถูุงุจุท ุงููุนุงููุฉ",
    text: "ุงูุจูุน ุงูุฏูููุฉ ูู ุฃูู ุงูุฃุฏูุฉ: ูุฏ ุชููู ุฏูููุฉ ููุฎููุฉ ูู ุงูุดููู ูุงูุญูุงู ูุชุญุช ุงูุฃุธุงูุฑุ ูุฌุจ ุงูุงูุชุฒุงู ุจุถูุงุจุท ุงููุนุงููุฉ: ุนุฏู ุชุญุฑูู ุดูุก ุฅูุง ูุถุฑูุฑุฉุ ุฑุณู ูุฑูููุ ุนุฏู ุงุณุชุฎุฏุงู ูุฑุงูู ุงูููุงูุ ุนุฒู ุงูุดููุฏ...",
    questions: [
      {type:'dnd', q:'ูุฏ ุชูุชุดุฑ ุขุซุงุฑ ุงูุฏู ูู <span class="droppable" data-answer="ุงูุชุฌุงููู">ุ</span> ูุงูุซููุจ ูุงููุณุงูุงุช ุบูุฑ ุงููุฑุฆูุฉ.', tokens:['ุงูุชุฌุงููู','ุงูููุฑุงุช','ุงูุฃุณูู'], a:'ุงูุชุฌุงููู'},
      {type:'mcq', q:'ุงูุจูุน ุงูุฏูููุฉ:', opts:['ููููุฉ ุงูุฃูููุฉ','ุฃูู ุงูุฃุฏูุฉ ุบุงูุจูุง','ุชูููู ุฏุงุฆููุง'], a:1},
      {type:'tof', q:'ูุฏ ุชูุฌุฏ ุขุซุงุฑ ุฏู ุบูุฑ ูุฑุฆูุฉ ุชุญุช ุงูุฃุธุงูุฑ.', a:true},
      {type:'fill', q:'ูุฌุจ ุฅุนุฏุงุฏ ุฑุณู _____ ูุงูู ูููุณุฑุญ.', choices:['ุฒุฎุฑูู','ูุฑููู','ุชุฌุฑูุจู'], a:'ูุฑููู'},
      {type:'mcq', q:'ูู ุถูุงุจุท ุงููุนุงููุฉ:', opts:['ุงุณุชุฎุฏุงู ููุงุดู ุงูููุงู','ุนุฏู ุชุญุฑูู ุงูุฃุดูุงุก ุฅูุง ููุถุฑูุฑุฉ','ูุชุญ ุตูุงุจูุฑ ุงูููุงู'], a:1},
      {type:'tof', q:'ูุฌูุฒ ุฌูุน ุงูุดููุฏ ูุนูุง ูุชูููุฑ ุงูููุช.', a:false},
      {type:'mcq', q:'ุชููุญุต ุงูููุงุจุณ ุงููุบุณููุฉ ุญุฏูุซูุง ุจุญุซูุง ุนู:', opts:['ุฑุงุฆุญุฉ ุนุทุฑ','ุขุซุงุฑ ุฏู','ุฃููุงู ุฒุงููุฉ'], a:1},
      {type:'tof', q:'ูููู ูููุญูู ุงุณุชุนูุงู ุฏูุฑุฉ ุงูููุงู ูู ุงููุณุฑุญ ุฅู ูุฒู.', a:false},
      {type:'fill', q:'ูุฌุจ ุนุฒู ุงูุดููุฏ ู_____ ุจูุฏุฑ ุงูุฅููุงู.', choices:['ุงููุดุชุจู ูููู','ุงูุดุฑุทุฉ','ุงูุฌูุฑุงู'], a:'ุงููุดุชุจู ูููู'},
      {type:'mcq', q:'ุนูู ุงููุญูู ุฃู:', opts:['ูุจุฏู ุฑุฃูู ููุฑูุง','ููุชูุน ุนู ููุงูุดุฉ ุงูุชูุงุตูู ููุซุจุช ูุง ูุฑู ููุณูุน','ููุชุธุฑ ุชุนูููุงุช ุงูุดููุฏ'], a:1},
    ] },
  { title: "ุงุนุชุจุงุฑุงุช ุฎุงุตุฉ: ูุตุงุจ โ ุฌุซุฉ โ ุฃุณูุญุฉ ูุงุฑูุฉ",
    text: "ุฅุฐุง ููุฌุฏ ูุตุงุจ ุชููุฏููู ุงูุฅุณุนุงูุงุช ููู ุนูู ุญุณุงุจ ุจุนุถ ุงูุฃุฏูุฉ. ุงูุฌุซุฉ ุชูุนุงููู ุฏููููุง ุฏูู ุชุญุฑูู ูุจู ุงููุญุต ุงููุงูู. ุงูุฃุณูุญุฉ ุชูุชุฑู ุจูุถุนูุง ูุชุญูู ูู ููุงุถุน ุขููุฉ ููุง ุชูุฏุฎู ุฃุฏูุงุช ูู ุงููุงุณูุฑุฉุ ุชูุญุฑููุฒ ุงูุฃุธุฑู ูุงูููุฐููุงุช ููู ุนูู ุญุฏุฉ.",
    questions: [
      {type:'dnd', q:'ููุฑุณู ุฎุท <span class="droppable" data-answer="ุฏุงุฆุฑู">ุ</span> ุญูู ุงูุฌุซุฉ ูุชุญุฏูุฏ ูููุนูุง.', tokens:['ุฏุงุฆุฑู','ูุณุชููู','ูุชุนุฑุฌ'], a:'ุฏุงุฆุฑู'},
      {type:'mcq', q:'ุนูุฏ ูุฌูุฏ ูุตุงุจ:', opts:['ุชุฃุฌูู ุงูุฅุณุนุงู','ุชูุฏูู ุงูุฅุณุนุงูุงุช ููุฑูุง','ุงูุงูุดุบุงู ุจุงูุชุตููุฑ ุฃูููุง'], a:1},
      {type:'tof', q:'ูุฌูุฒ ุชุญุฑูู ุงูุฌุซุฉ ูุจู ุงููุญุต ุงูููุตู.', a:false},
      {type:'fill', q:'ุนูุฏ ุฑูุน ูุณุฏุณ ูููุณู ูู _____ (ูุงูู ุงูุฒูุงุฏ/ููุทุฑุฉ ุงูุชุชู).', choices:['ุงูุณุจุทุงูุฉ','ูุงูู ุงูุฒูุงุฏ','ุงูููุจุถ'], a:'ูุงูู ุงูุฒูุงุฏ'},
      {type:'mcq', q:'ูุง ูุฌูุฒ ุฅุฏุฎุงู ุฃุฏุงุฉ ูู ุงููุงุณูุฑุฉ ูุฃู ุฐูู ูุฏ:', opts:['ูุญุณู ุงูุฏููู','ูุชูู ุงูุขุซุงุฑ','ูุณูู ุงูุฑูุน'], a:1},
      {type:'tof', q:'ุงูุฃุธุฑู ุงููุงุฑุบุฉ ุชูุญุฑุฒ ููู ุนูู ุญุฏุฉ.', a:true},
      {type:'mcq', q:'ุฅู ููุฌุฏ ุงูุณูุงุญ ุจูุฏ ุงููุชูู ูุฌุจ:', opts:['ุงูุชุฑุงุถ ุงูุงูุชุญุงุฑ','ุงูุชุญูู ูู ุตุญุฉ ุงููุถุน','ุฅุฒุงูุชู ุณุฑูุนูุง'], a:1},
      {type:'tof', q:'ูููุถูู ุฑูุน ุงูุฃุธุฑู ุจุนูุฏุงู ุงูุซูุงุจ ูุญูุธ ุงูุขุซุงุฑ ุงูุนุงููุฉ.', a:true},
      {type:'fill', q:'ูุฌูุฏ ุขุซุงุฑ ุฏู ุฃู ูุณูุฌ ุฏุงุฎู ุงููุงุณูุฑุฉ ูุฏ ูููู ุฐุง ูููุฉ _____.', choices:['ุฌูุงููุฉ','ุฌูุงุฆูุฉ','ุชุฌุงุฑูุฉ'], a:'ุฌูุงุฆูุฉ'},
      {type:'mcq', q:'ุนูุฏ ููู ุงููุตุงุจ:', opts:['ุนุฏู ูุฑุงููุฉ ุถุงุจุท','ูุฑุงููุฉ ุถุงุจุท ูุณูุงุน ุฃู ุฃููุงู ูุญุชููุฉ','ุฅุทูุงุก ุงูุฃููุงุฑ'], a:1},
    ] }
];

let currentScene = -1;
let timeLeft = 60;
let timerId = null;
let answers = [];
let sceneStarted = false;

let voiceNormal=null;
function pickVoices(){
  const voices = speechSynthesis.getVoices();
  voiceNormal = voices.find(v=>/ar/i.test(v.lang) && /male|ุฐูุฑ|Abdul|Hamed|Omar|Mehdi|Tariq|Maged/i.test(v.name)) || voices.find(v=>/ar/i.test(v.lang)) || null;
}
speechSynthesis.onvoiceschanged = pickVoices;
pickVoices();

function speak(text, {rate=1, pitch=1, volume=1}={}){
  return new Promise(res=>{
    const clean = (text||'').replace(/[_]{2,}/g,' ').replace(/_/g,' ');
    const u = new SpeechSynthesisUtterance(clean);
    u.lang = 'ar-AE';
    u.rate = rate; u.pitch = pitch; u.volume = volume;
    if(voiceNormal) u.voice = voiceNormal;
    u.onend = ()=>res();
    try{ speechSynthesis.speak(u); }catch(e){ res(); }
  });
}
function stopSpeak(){ try{ speechSynthesis.cancel(); }catch(e){} }

let fadeTimer=null;
function musicFadeTo(target=0.15, ms=800){
  if(fadeTimer) clearInterval(fadeTimer);
  const step = (target - bgMusic.volume) / (ms/100);
  fadeTimer = setInterval(()=>{
    let v = bgMusic.volume + step;
    if((step>0 && v>=target) || (step<0 && v<=target)){
      bgMusic.volume = target; clearInterval(fadeTimer);
      if(target===0){ bgMusic.pause(); }
    }else{
      bgMusic.volume = Math.max(0, Math.min(1, v));
    }
  },100);
}

btnStart.addEventListener('click', async ()=>{
  stopSpeak();
  try{ bgMusic.currentTime=0; bgMusic.play(); }catch(e){}
  musicFadeTo(0.15, 800);
  await speak("ูุฑุญุจูุง ุจู ุฃููุง ุงูุทุงูุจ ุงูุถุงุจุทุ ุงุณุชุนุฏ ูุฎูุถ ุงุฎุชุจุงุฑ ุงูููุฏุงู ูู ูุนุงููุฉ ูุณุฑุญ ุงูุฌุฑููุฉ.", {rate:0.98, pitch:0.9, volume:1});
  musicFadeTo(0, 800);
  goNext();
});

function goNext(){
  stopSpeak();
  if(secStart.classList.contains('active')){
    secStart.classList.remove('active');
    secScene.classList.add('active');
    currentScene = -1;
    nextScene();
    return;
  }
  if(secScene.classList.contains('active')){
    if(currentScene < SCENES.length-1){
      nextScene();
    }else{
      showResult();
    }
    return;
  }
}
function goPrev(){
  stopSpeak();
  if(secScene.classList.contains('active') && currentScene>0){
    currentScene -= 2;
    nextScene();
  } else if(secScene.classList.contains('active') && currentScene===0){
    secScene.classList.remove('active');
    secStart.classList.add('active');
    btnNextTop.disabled = true;
    timerEl.textContent = "--:--";
    scnIndexEl.textContent = "-";
  }
}

function nextScene(){
  stopSpeak();
  clearInterval(timerId);
  timeLeft = 60;
  btnNextTop.disabled = false;
  currentScene++;
  scnIndexEl.textContent = (currentScene+1);
  sceneStarted = false;
  try{ bgMusic.currentTime=0; bgMusic.play(); }catch(e){}
  musicFadeTo(0.15, 700);

  const scn = SCENES[currentScene];
  sceneTitleEl.textContent = "ุณููุงุฑูู "+(currentScene+1)+" โ "+scn.title;
  sceneTextEl.textContent = scn.text;
  renderQuestions(scn);

  updateTimer(); timerId = setInterval(tick, 1000);

  setTimeout(async ()=>{
    sceneStarted = true;
    musicFadeTo(0.08, 400);
    await speak(scn.text, {rate:1.0, pitch:1.0, volume:1});
    musicFadeTo(0.15, 600);
  }, 6000);
}

function tick(){
  timeLeft--;
  updateTimer();
  if(timeLeft<=0){
    clearInterval(timerId);
    musicFadeTo(0, 700);
    goNext();
  }
}
function updateTimer(){
  const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const s = (timeLeft%60).toString().padStart(2,'0');
  timerEl.textContent = `${m}:${s}`;
  const startTimer = document.querySelector('#start .card-header .badge');
  if(startTimer && secStart.classList.contains('active')){
    startTimer.textContent = `โฑ ุงูููุช ุงููุชุจูู: ${m}:${s}`;
  }
}

btnNextTop.addEventListener('click', ()=>{
  clearInterval(timerId);
  musicFadeTo(0, 700);
  goNext();
});

function renderQuestions(scn){
  questionsEl.innerHTML = "";
  scn.questions.forEach((item, idx)=>{
    const qDiv = document.createElement('div'); qDiv.className='q';
    // ๐จ ุฅุถุงูุฉ ุนููุงู ููุน ุงูุณุคุงู
    const typeLabel = document.createElement('div');
    typeLabel.className = 'question-type';
    if(item.type === 'dnd') typeLabel.textContent = '๐ฆ ุณุคุงู ุณุญุจ ูุฅููุงุช';
    else if(item.type === 'mcq') typeLabel.textContent = '๐ฅ ุณุคุงู ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ';
    else if(item.type === 'tof') typeLabel.textContent = '๐ฉ ุณุคุงู ุตุญ ุฃู ุฎุทุฃ';
    else if(item.type === 'fill') typeLabel.textContent = '๐จ ุฃููู ุงููุฑุงุบ';
    else typeLabel.textContent = 'ุณุคุงู ุนุงู';
    qDiv.appendChild(typeLabel);

    const qTitle = document.createElement('h4');
    qTitle.textContent = `ุณ${idx+1}. ${item.q.replace(/<[^>]*>?/gm,'')}`;
    qDiv.appendChild(qTitle);

    if(item.type==='mcq'){
      const optsDiv = document.createElement('div'); optsDiv.className='options';
      item.opts.forEach((op, oi)=>{
        const b = document.createElement('button'); b.className='opt'; b.textContent = op;
        b.addEventListener('click',()=>selectMCQ(item, idx, oi, b, op));
        optsDiv.appendChild(b);
      });
      qDiv.appendChild(optsDiv);
    }else if(item.type==='tof'){
      const optsDiv = document.createElement('div'); optsDiv.className='options';
      [['ุตุญ',true],['ุฎุทุฃ',false]].forEach(([label,val])=>{
        const b = document.createElement('button'); b.className='opt'; b.textContent = label;
        b.addEventListener('click',()=>selectTOF(item, idx, val, b, label));
        optsDiv.appendChild(b);
      });
      qDiv.appendChild(optsDiv);
    }else if(item.type==='fill'){
      const p = document.createElement('p');
      const parts = item.q.split('_____');
      if(parts.length>1){
        p.innerHTML = parts[0] + '<span class="blank" id="blank_'+currentScene+'_'+idx+'">ุ</span>' + parts[1];
      }else{
        p.innerHTML = item.q.replace('ููุง','ููุง <span class="blank" id="blank_'+currentScene+'_'+idx+'">ุ</span> ');
      }
      qDiv.appendChild(p);
      const wrap = document.createElement('div'); wrap.className='fill-wrap';
      item.choices.forEach(ch=>{
        const c = document.createElement('span'); c.className='fill-choice'; c.textContent = ch;
        c.addEventListener('click',()=>selectFill(item, idx, ch));
        wrap.appendChild(c);
      });
      qDiv.appendChild(wrap);
    }else if(item.type==='dnd'){
const p = document.createElement('p');
p.innerHTML = item.q;
qDiv.appendChild(p);

// ๐น ูุฃุฎูุฑ ุฑุจุท ุงูุฃุญุฏุงุซ ููููุงู ุญุชู ุชูุญููู ุงูุนูุงุตุฑ ูุนูููุง ูู ุงูู DOM
setTimeout(()=>{
  const droppables = qDiv.querySelectorAll('.droppable');
  droppables.forEach((dropEl)=>{
    dropEl.addEventListener('dragover', ev=>{
      ev.preventDefault();
      dropEl.classList.add('over');
    });

    dropEl.addEventListener('dragleave', ()=>{
      dropEl.classList.remove('over');
    });

    dropEl.addEventListener('drop', ev=>{
      ev.preventDefault();
      dropEl.classList.remove('over');

      const tok = ev.dataTransfer.getData('text/plain');
      dropEl.textContent = tok;

      const correct = (tok === (item.a || dropEl.dataset.answer));
      if(correct){
        sndCorrect.currentTime=0; sndCorrect.play().catch(()=>{});
        speak("ุฅุฌุงุจุชู ุตุญูุญุฉ",{rate:1.05, pitch:1.0});
      } else {
        sndWrong.currentTime=0; sndWrong.play().catch(()=>{});
        speak("ุฅุฌุงุจุชู ุฎุงุทุฆุฉ",{rate:1.0, pitch:1.0});
      }

      pushAnswer(currentScene, idx, correct, tok, (item.a || dropEl.dataset.answer), dropEl.parentElement.textContent);
    });
  });
}, 100); // ุชุฃุฎูุฑ 100ms ูุชุฃููุฏ ุชุญููู ุงูุนูุงุตุฑ ูุนูููุง

const bank = document.createElement('div');
bank.className='dnd-bank';

item.tokens.forEach(tok=>{
  const t = document.createElement('span');
  t.className='draggable';
  t.textContent=tok;
  t.setAttribute('draggable','true');
  t.dataset.token = tok;
  t.addEventListener('dragstart', ev=>{
    ev.dataTransfer.setData('text/plain', tok);
  });
  bank.appendChild(t);
});

qDiv.appendChild(bank);

      const droppables = p.querySelectorAll('.droppable');
      droppables.forEach((dropEl)=>{
        dropEl.addEventListener('dragover', ev=>{ ev.preventDefault(); dropEl.classList.add('over'); });
        dropEl.addEventListener('dragleave', ()=> dropEl.classList.remove('over'));
dropEl.addEventListener('drop', ev=>{
  ev.preventDefault();
  dropEl.classList.remove('over');
  const tok = ev.dataTransfer.getData('text/plain');
  dropEl.textContent = tok;
  const correct = (tok === (item.a || dropEl.dataset.answer));
  if(correct){ sndCorrect.currentTime=0; sndCorrect.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุตุญูุญุฉ",{rate:1.05, pitch:1.0}); }
  else { sndWrong.currentTime=0; sndWrong.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุฎุงุทุฆุฉ",{rate:1.0, pitch:1.0}); }
  pushAnswer(currentScene, idx, correct, tok, (item.a || dropEl.dataset.answer), dropEl.parentElement.textContent);
});

      });
    }
    questionsEl.appendChild(qDiv);
  });
}

let answeredMap = new Map();
function alreadyAnswered(sceneIdx, qIdx){
  return answeredMap.has(sceneIdx+"-"+qIdx);
}
function pushAnswer(sceneIdx, qIdx, correct, userAnswer, correctAnswer, text){
  if(alreadyAnswered(sceneIdx,qIdx)) return;
  const obj = {scene:sceneIdx, idx:qIdx, correct, userAnswer, correctAnswer, text};
  answers.push(obj);
  answeredMap.set(sceneIdx+"-"+qIdx,true);
}

function selectMCQ(item, idx, choiceIndex, btn, text){
  const correct = (choiceIndex===item.a);
  if(correct){ sndCorrect.currentTime=0; sndCorrect.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุตุญูุญุฉ",{rate:1.05, pitch:1.0}); }
  else { sndWrong.currentTime=0; sndWrong.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุฎุงุทุฆุฉ",{rate:1.0, pitch:1.0}); }
  btn.parentElement.querySelectorAll('.opt').forEach(o=>o.classList.remove('selected'));
  btn.classList.add('selected');
  pushAnswer(currentScene, idx, correct, text, item.opts[item.a], item.q);
}
function selectTOF(item, idx, val, btn, label){
  const correct = (val===item.a);
  if(correct){ sndCorrect.currentTime=0; sndCorrect.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุตุญูุญุฉ",{rate:1.05, pitch:1.0}); }
  else { sndWrong.currentTime=0; sndWrong.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุฎุงุทุฆุฉ",{rate:1.0, pitch:1.0}); }
  btn.parentElement.querySelectorAll('.opt').forEach(o=>o.classList.remove('selected'));
  btn.classList.add('selected');
  pushAnswer(currentScene, idx, correct, label, (item.a?'ุตุญ':'ุฎุทุฃ'), item.q);
}
function selectFill(item, idx, chosen){
  const blank = document.getElementById('blank_'+currentScene+'_'+idx);
  if(blank) blank.textContent = chosen;
  const correct = (chosen===item.a);
  if(correct){ sndCorrect.currentTime=0; sndCorrect.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุตุญูุญุฉ",{rate:1.05, pitch:1.0}); }
  else { sndWrong.currentTime=0; sndWrong.play().catch(()=>{}); speak("ุฅุฌุงุจุชู ุฎุงุทุฆุฉ",{rate:1.0, pitch:1.0}); }
  pushAnswer(currentScene, idx, correct, chosen, item.a, item.q);
}

function showResult(){
  stopSpeak();
  secScene.classList.remove('active');
  secResult.classList.add('active');
  btnNextTop.disabled = true;
  timerEl.textContent = "--:--";
  scnIndexEl.textContent = "-";
  musicFadeTo(0, 700);

  const totalQs = SCENES.reduce((s,sc)=>s+sc.questions.length,0);
  const correctCount = answers.filter(a=>a.correct).length;
  const score = Math.round((correctCount/totalQs)*100);

  finalMsgEl.innerHTML = `ุฏุฑุฌุชู ุงูุฅุฌูุงููุฉ: <b>${score}%</b> โ (${correctCount} ูู ${totalQs})`;
  scoreFillEl.style.width = score+"%";

  wrongListEl.innerHTML = "";
  const wrongs = [];
  SCENES.forEach((sc, si)=>{
    sc.questions.forEach((q, qi)=>{
      const a = answers.find(x=>x.scene===si && x.idx===qi);
      if(!a){
        const div = document.createElement('div'); div.className='result-line';
        const correctAns = (q.type==='mcq')? q.opts[q.a] :
                           (q.type==='tof')? (q.a?'ุตุญ':'ุฎุทุฃ') :
                           (q.type==='fill')? q.a :
                           (q.type==='dnd')? (q.a || 'โ') : 'โ';
        div.innerHTML = `<div><b>ุณ${qi+1} โ ${ (q.q||'').replace(/<[^>]*>?/gm,'') }</b></div>
        <div class="small">ูู ุชูุฌุจ ุนูู ูุฐุง ุงูุณุคุงู โ ุงูุตุญูุญุฉ: <span style="color:#9bffb7">${correctAns}</span></div>`;
        wrongListEl.appendChild(div);
        wrongs.push({text:(q.q||'').replace(/<[^>]*>?/gm,''), userAnswer:'ูู ุชูุฌุจ', correctAnswer:correctAns});
      }else if(!a.correct){
        const div = document.createElement('div'); div.className='result-line';
        div.innerHTML = `<div><b>ุณ${qi+1} โ ${a.text}</b></div>
        <div class="small">ุฅุฌุงุจุชู: <span style="color:#ff9b9b">${a.userAnswer}</span> โ ุงูุตุญูุญุฉ: <span style="color:#9bffb7">${a.correctAnswer}</span></div>`;
        wrongListEl.appendChild(div);
        wrongs.push(a);
      }
    });
  });

  (async ()=>{
    if(score<80){
      await speak("ุฏุฑุฌุชู ููุฎูุถุฉ. ุฃูุช ุจุญุงุฌุฉ ุฅูู ูุฑุงุฌุนุฉ ุงูุฏุฑุณ ูุฑุฉ ุฃุฎุฑู.", {rate:0.98, pitch:1.0});
    }else{
      await speak("ุฃุญุณูุช ูุง ุงูุทุงูุจ ุงูุถุงุจุท. ููุฏ ุฃุซุจุช ููุงุกุชู ูู ูุนุงููุฉ ูุณุฑุญ ุงูุฌุฑููุฉ.", {rate:1.0, pitch:1.0});
    }
    for(const w of wrongs){
      await speak("ุนุฒูุฒู ุงูุทุงูุจ ุงูุถุงุจุทุ "+ (w.userAnswer==='ูู ุชูุฌุจ' ? "ูู ุชุฌุจ ุนูู ุงูุณุคุงู ุงูุชุงูู." : "ุฅุฌุงุจุชู ุฎุงุทุฆุฉ ูู ุงูุณุคุงู ุงูุชุงูู.") , {rate:1.0, pitch:1.0});
      await speak("ุงูุณุคุงู: "+w.text, {rate:1.02, pitch:1.0});
      await speak((w.userAnswer==='ูู ุชูุฌุจ' ? "ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: " : "ุฅุฌุงุจุชู ูุงูุช: "+w.userAnswer+" . ุจูููุง ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: ") + w.correctAnswer, {rate:1.02, pitch:1.0});
    }
  })();
}

document.getElementById('btnRetry').addEventListener('click', async ()=>{
  stopSpeak();
  await speak("ูููุจุฏุฃ ูู ุฌุฏูุฏ ุฃููุง ุงูุทุงูุจ ุงูุถุงุจุทุ ุฃุธูุฑ ูุฏุฑุงุชู ุงูุชุญููููุฉ ูุฑุฉ ุฃุฎุฑู.", {rate:1.0, pitch:1.0});
  answers = []; answeredMap.clear();
  currentScene = -1; timerEl.textContent="--:--"; scnIndexEl.textContent="-";
  secResult.classList.remove('active');
  secStart.classList.add('active');
  btnNextTop.disabled = true;
});

window.addEventListener('beforeunload', ()=>speechSynthesis.cancel());

</script>
</body>
</html>
