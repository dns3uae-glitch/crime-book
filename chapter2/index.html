<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>chapter2</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #fdd835;
      direction: rtl;
      height: 100vh;
      overflow-x: hidden;
    }
body {
      overflow: auto;
overflow-y: auto;
  overflow-x: hidden;
    }
 body::-webkit-scrollbar {
      width: 10px;
    }
body::-webkit-scrollbar-track {
      background: #111;
    }

.image-box {
    width: 95%;
    max-width: 900px;
    background-color: #222;
    border: 2px solid #fdd835;
    border-radius: 14px;
    box-shadow: 0 0 40px rgba(255, 255, 0, 0.3);
    padding: 20px;
    margin-bottom: 30px;
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    justify-items: center;
  }

  .gallery img {
    width: 100%;
    max-width: 200px;
    height: auto;
    object-fit: cover;
    border: 3px solid #fdd835;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.4s ease, box-shadow 0.4s ease;
  }

.gallery img.zoomed {
  transform: scale(2.5);
  z-index: 1000;
  position: relative;
  box-shadow: 0 0 20px rgba(255, 255, 0, 0.6);
}


  @media (max-width: 600px) {
    .gallery img.zoomed {
      transform: scale(1.8);
    }
  }
  @media (max-width: 600px) {
    .gallery img.zoomed {
      transform: scale(1.8); /* ✅ زوم أقل للجوال */
    }
  }
    body::-webkit-scrollbar-thumb:hover {
      background-color: #ffe066;
    }

    header {
      width: 100%;
      height: clamp(60px, 8vh, 70px);
      background-color: #000;
      color: #fdd835;
      text-shadow: 1px 1px 2px black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(18px, 2vw, 22px);
      font-weight: bold;
      letter-spacing: 1px;
      border-top: 4px solid #fdd835;
      border-bottom: 4px solid #fdd835;
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
      position: fixed;
      top: 0;
      z-index: 100;
    }

    .page-wrapper {
  padding-top: clamp(70px, 8vh, 80px);
  padding-bottom: clamp(70px, 8vh, 80px);
  min-height: 100vh;
  display: flex;
  flex-direction: column; /* ✅ تكديس عمودي */
  align-items: center;     /* ✅ توسيط أفقي */
  box-sizing: border-box;
}

.video-frame {
      width: 95%;
      max-width: 900px;
      margin: 0 auto 30px;
      height: clamp(250px, 50vh, 500px);
      border: 5px solid #fdd835;
      box-shadow: 0 0 40px rgba(255, 255, 0, 0.4);
      border-radius: 14px;
      background-color: black;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    iframe {
      width: 96%;
      height: 92%;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    .intro-text {
      text-align: center;
      font-size: clamp(16px, 2vw, 20px);
      margin-bottom: 20px;
    }

    .crime-box {
      text-align: right; /* ✅ محاذاة النص داخل المستطيل */
      font-size: clamp(16px, 2vw, 20px);
      padding: 15px 25px;
      border: 2px solid #fdd835;
      border-radius: 10px;
      background-color: #222;
      color: #fdd835;
      cursor: pointer;
      transition: all 0.3s ease;
      width: min(90%, 600px);
      margin: 0 0 20px auto; /* ✅ المستطيل بمحاذاة اليمين */
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.2);
    }

   .crime-box summary {
  list-style: none;
  outline: none;
  position: relative;
  font-weight: bold;
  text-align: center; /* ✅ النص في المنتصف */
  padding-right: 30px; /* يبقى للسهم */
}


    .crime-box summary::before {
      content: "";
      position: absolute;
      right: 0;
      top: 8px;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-right: 8px solid #fdd835;
      transition: transform 0.3s ease;
    }

    .crime-box[open] summary::before {
      transform: rotate(-90deg);
    }

    .crime-box p {
      margin-top: 15px;
      font-size: clamp(15px, 2vw, 18px);
      color: #ffffff;
      animation: fadeInAnswer 0.6s ease;
    }

    @keyframes fadeInAnswer {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .next-button, .prev-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
    }

    .next-button {
      left: 80px;
    }

    .prev-button {
      right: 20px;
    }

    .center-box {
      width: 95%;
      max-width: 900px;
      background-color: #222;
      border: 2px solid #fdd835;
      border-radius: 14px;
      box-shadow: 0 0 40px rgba(255, 255, 0, 0.3);
      padding: 40px;
      font-size: 28px;
      line-height: 2;
      text-align: center;
      color: #fff;
    }

    mark {
      background-color: inherit;
      padding: 2px 4px;
      border-radius: 4px;
      cursor: pointer;
    }

    footer {
      width: 100%;
      height: clamp(60px, 8vh, 70px);
      background-color: #000;
      border-top: 4px solid #fdd835;
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
      position: fixed;
      bottom: 0;
      z-index: 100;
    }

    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
      padding: 0 240px;
    }

    .nav-left, .nav-right, .nav-center {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-button {
      background-color: #222;
      color: #fdd835;
      border: 2px solid #fdd835;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      transition: 0.3s;
    }

    .nav-button:hover {
      background-color: rgba(255,255,0,0.2);
      transform: scale(1.05);
    }

    #footer-indicators button {
      background: #fdd835;
      color: #000;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(255,255,0,0.3);
      display: none;
    }
  </style>
</head>
<body>
  <header>📘 الفصل الثاني</header>

  
  <div class="page-wrapper">
  <p>&#160;</p>

  <!-- مربع الصور -->
  <div class="image-box">
    <div class="gallery">
      <img src="https://i2-prod.mirror.co.uk/incoming/article29080061.ece/ALTERNATES/n615/0_DSC_0282jpeg.jpg" alt="صورة 1" onclick="toggleZoom(this)">
      <img src="https://tse3.mm.bing.net/th/id/OIP.JhbLJnKwkT1LX21pC90bhwHaE8?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3" alt="صورة 2" onclick="toggleZoom(this)">
      <img src="https://ichef.bbci.co.uk/news/640/cpsprodpb/DB23/production/_113699065_116787543_1411508689042892_3568722622051133646_n.jpg" alt="صورة 3" onclick="toggleZoom(this)">
      <img src="https://assets-natgeotv.techops.disn.io/Photos/25/63266.jpg" alt="صورة 4" onclick="toggleZoom(this)">
    </div>
  </div>

  <!-- الجملة التوضيحية -->
  <div class="intro-text">
    بعد مشاهدة صور مسارح الجريمة السابقة يمكننا توضيح بعض العناصر الأساسية التالية
  </div>

  <!-- المربعات التوضيحية -->
  <details class="crime-box">
    <summary>مسرح الجريمة المغـلق (الداخلى)</summary>
    <p>هو المكان المحدد الذى ارتكبت فيه الجريمة ويمكن غلقه، ويوجد داخل المبانى السكنية أو التجارية، وكل الأماكن التى يمكن غلقها والسيطرة عليها ، ويشمل المسرح أيضاً أماكن الدخول والخروج بالإضافة إلى ملحقات المسرح من أبنية وكذلك منطقة الدرج والدهاليز، حيث يكون له مداخل ومنافذ يمكن فحصها ومعاينتها تتمثل فى باب المكان والذى بفحصه يمكن تحديد طريقة الدخول، وطريق الجاني في الوصول إلى داخل مسرح الجريمة.</p>
  </details>

  <details class="crime-box">
    <summary>مسرح الجريمة المفتوح (الخارجى)</summary>
    <p>وذلك يعنى أن مسرح الجريمة يكون مفتوحاً فى حالة عدم وجود حدود له وانطلاق مساحته لمقاييس مترامية الأطراف، مثل الأراضى الزراعية أو الطرق السريعة، والأماكن المكشوفة المهجورة، وتعد هذه الأماكن مسرحاً لارتكاب الجريمة حيث يجنح الجانى لارتكاب الجريمة ويخطط لها على أمل أن يتم طمس معالم الأدلة التى يتركهـا، والتى قـد تساهم فى كشف غموض الجريمة وتحديد فاعلها</p>
  </details>

  <details class="crime-box">
    <summary>الرقعة المكانية التى حدثت فوقها الواقعة الإجرامية </summary>
    <p>يُقصد بمسرح الجريمة فى رأى البعض الآخر أنه الرقعة المكانية التى حدثت فوقها الواقعة الإجرامية بكافة جزئياتها ومراحلها وخاصة الحدث الإجرامى.</p>
  </details>

  <details class="crime-box">
    <summary>مسرح الجريمة المتحرك</summary>
    <p>•	 تتنوع مسارح الجريمة كذلك حسب شكل المكان الذى ارتكبت فيه الجريمة سواء كان عقاراً أو منقولاً فمسرح الجريمة العقارى هو الذى يقع على أرض ثابتة، أما مسرح الجريمة المنقول فيقع فى أماكن متحركة بطبيعتها كالجرائم التى تقع فى السفن والطائرات</p>
  </details>

</div>




  <footer>
    <div class="footer-content">
      <div class="nav-left">
        <button class="nav-button" onclick="goToPrevious()">⬅️ السابق</button>
      </div>
      <div class="nav-center" id="footer-indicators">
        <button id="highlight-alert">📌 كلمات مظللة</button>
        <button id="notebook-indicator">📔 ملاحظة محفوظة</button>
      </div>
      <div class="nav-right">
        <button class="nav-button" onclick="goToNext()">➡️ التالي</button>
      </div>
    </div>
  </footer>
<!-- قائمة الأدوات العائمة -->
<div id="tool-menu" style="display:none; position:absolute; background:#222; border:2px solid #fdd835; padding:10px; border-radius:8px; z-index:1000; display:flex; gap:10px;">
  <button id="tool-highlight">✏️</button>
  <button id="tool-search">🔍</button>
  <button id="tool-speak">🔊</button>
  <button id="tool-notebook">📔</button>
</div>

<!-- قائمة التظليل والملاحظة -->
<div id="highlight-menu" style="display:none; position:absolute; background:#222; border:2px solid #fdd835; padding:10px; border-radius:8px; z-index:1000; width:280px;" onclick="event.stopPropagation();">
  <div class="colors" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-bottom:10px;">
    <span class="color" data-color="#fdd835" style="background:#fdd835; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#ff4081" style="background:#ff4081; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#40c4ff" style="background:#40c4ff; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#4caf50" style="background:#4caf50; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#ff9800" style="background:#ff9800; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#9c27b0" style="background:#9c27b0; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#00bcd4" style="background:#00bcd4; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#795548" style="background:#795548; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#e91e63" style="background:#e91e63; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#8bc34a" style="background:#8bc34a; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
  </div>
  <textarea id="note-input" placeholder="اكتب ملاحظة هنا..." style="width:100%; height:60px; font-size:16px; padding:8px; resize:vertical; border-radius:6px; border:1px solid #fdd835; background:#fff; color:#000;" onclick="event.stopPropagation();"></textarea>
  <div id="highlight-actions" style="margin-top:10px; display:flex; gap:10px;"></div>
</div>

<!-- دفتر الملاحظات -->
<div id="notebook-panel" style="position:fixed; bottom:-300px; left:50%; transform:translateX(-50%); width:90%; max-width:600px; background:#222; border:2px solid #fdd835; border-radius:12px 12px 0 0; padding:20px; box-shadow:0 -4px 20px rgba(255,255,0,0.3); transition:bottom 0.4s ease; z-index:9999; color:#fff; text-align:center;">
  <h3 style="margin-top:0;">📔 ملاحظات عامة عن الصفحة</h3>
  <textarea id="notebook-input" placeholder="اكتب ملاحظتك هنا..." style="width:100%; height:100px; font-size:16px; padding:10px; border-radius:6px; border:1px solid #fdd835; resize:vertical; margin-top:10px; background:#fff; color:#000;"></textarea>
  <div style="display:flex; justify-content:center; gap:12px; margin-top:12px;">
    <button id="save-notebook" style="background:#4caf50; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">💾 حفظ</button>
    <button id="delete-notebook" style="background:#ff4081; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">🗑️ حذف</button>
  </div>
</div>

<!-- قائمة التظليلات المحفوظة -->
<div id="highlight-list" style="display:none; position:fixed; bottom:80px; left:20px; width:300px; max-height:300px; overflow-y:auto; background:#222; border:2px solid #fdd835; border-radius:12px; padding:10px; box-shadow:0 0 20px rgba(255,255,0,0.3); z-index:9999; color:#fff;">
  <h3 style="margin-top:0;">📌 الكلمات المظللة</h3>
  <div id="highlight-items"></div>
</div>

<!-- زر فتح الدردشة -->
<button id="chat-toggle" style="background:#fdd835; color:#000; border:none; border-radius:50%; width:55px; height:55px; font-size:26px; cursor:pointer; position:fixed; bottom:90px; right:20px; box-shadow:0 0 10px rgba(255,255,0,0.5); z-index:1201;">💬</button>

<!-- نافذة الدردشة -->
<div class="chat-container" id="chatBox" style="position:fixed; bottom:160px; right:20px; max-width:400px; background:#222; border:2px solid #fdd835; border-radius:12px; box-shadow:0 0 20px rgba(255,255,0,0.3); display:none; flex-direction:column; overflow:hidden; z-index:1202;">
  <div class="chat-header" style="background:#000; color:#fdd835; padding:12px; font-size:18px; text-align:center; border-bottom:2px solid #fdd835;">مساعدك الذكي</div>
  <div class="chat-body" id="chatBody" style="padding:10px; height:250px; overflow-y:auto; background:#111;"></div>
  <div class="chat-footer" style="display:flex; padding:10px; border-top:1px solid #fdd835; background:#000;">
    <input type="text" id="userInput" placeholder="اكتب سؤالك هنا..." style="flex:1; padding:8px; border:none; border-radius:5px; font-size:14px; background:#222; color:#fff;">
    <button id="sendBtn" style="background:#fdd835; color:#000; border:none; padding:8px 12px; margin-left:8px; border-radius:5px; cursor:pointer; font-weight:bold;">إرسال</button>
  </div>
</div>
   <!-- ✅ D-ID Avatar (الافتار في اليمين) -->
  <script type="module"
    src="https://agent.d-id.com/v2/index.js"
    data-mode="fabio"
    data-client-key="Z29vZ2xlLW9hdXRoMnwxMTYxMTA1NDg0NzE4MjIxMjEzNzU6ZW1hOGpRYnRPcnJOSENjeU9nTUF3"
    data-agent-id="v2_agt_JPqY3TqZ"
    data-name="did-agent"
    data-monitor="true"
    data-orientation="horizontal"
    data-position="left">
  </script>

<script>
  function goToPrevious() {
    window.location.href = 'https://dns3uae-glitch.github.io/crime-book/ch1-1';
  }

  function goToNext() {
    window.location.href = 'https://dns3uae-glitch.github.io/crime-book/3d';
  }

  function getEmiratiMaleVoice() {
    const voices = speechSynthesis.getVoices();
    return voices.find(v => v.lang === 'ar-AE' && v.name.toLowerCase().includes('male')) ||
           voices.find(v => v.lang === 'ar-AE') ||
           voices.find(v => v.lang.includes('ar') && v.name.toLowerCase().includes('male')) ||
           voices.find(v => v.lang.includes('ar')) ||
           voices.find(v => v.lang.includes('en')) ||
           voices[0];
  }

  function speakText(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    const voice = getEmiratiMaleVoice();
    if (voice) {
      utterance.voice = voice;
      utterance.lang = voice.lang;
    }
    speechSynthesis.cancel();
    setTimeout(() => {
      speechSynthesis.speak(utterance);
    }, 100);
  }
let voicesReady = false;
speechSynthesis.onvoiceschanged = () => {
  voicesReady = true;
};

  const toolMenu = document.getElementById('tool-menu');
  const highlightMenu = document.getElementById('highlight-menu');
  const noteInput = document.getElementById('note-input');
  const highlightAlert = document.getElementById('highlight-alert');
  const notebookIndicator = document.getElementById('notebook-indicator');
  const textBox = document.getElementById('text-box');
  let selectedText = '';
  let selectedRange = null;

  document.addEventListener('mouseup', (e) => {
  if (e.target.closest('#highlight-menu')) return;

  const selection = window.getSelection();
  if (selection.toString().trim().length > 0) {
    selectedText = selection.toString();
    selectedRange = selection.getRangeAt(0);
    const rect = selectedRange.getBoundingClientRect();
    toolMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
    toolMenu.style.left = `${rect.left + window.scrollX}px`;
    toolMenu.style.display = 'flex';
    highlightMenu.style.display = 'none';
  } else {
    toolMenu.style.display = 'none';
    highlightMenu.style.display = 'none';
  }
});


  document.getElementById('tool-highlight').onclick = () => {
    highlightMenu.style.top = toolMenu.style.top;
    highlightMenu.style.left = toolMenu.style.left;
    highlightMenu.style.display = 'block';
    toolMenu.style.display = 'none';
  };

  document.getElementById('tool-search').onclick = () => {
    if (selectedText.trim()) {
     const query = encodeURIComponent(selectedText.trim());
window.open(
  `https://www.google.com/search?q=${query}`,
  'popupWindow',
  'width=800,height=600,top=100,left=200'
);


    }
  };
document.getElementById('tool-speak').onclick = () => {
  if (selectedText.trim()) {
    speakText(selectedText.trim());
    toolMenu.style.display = 'none';
  }
};

  document.querySelectorAll('.color').forEach(colorBtn => {
    colorBtn.addEventListener('click', () => {
      const color = colorBtn.getAttribute('data-color');
      const note = noteInput.value.trim();
      const mark = document.createElement('mark');
      mark.textContent = selectedText;
      mark.style.backgroundColor = color;
      mark.setAttribute('data-note', note);
      mark.setAttribute('data-text', selectedText);
      selectedRange.deleteContents();
      selectedRange.insertNode(mark);
      saveHighlight(selectedText, color, note);
      highlightMenu.style.display = 'none';
      noteInput.value = '';
    });
  });

  function saveHighlight(text, color, note) {
    const saved = JSON.parse(localStorage.getItem('highlights') || '[]');
    saved.push({ text, color, note });
    localStorage.setItem('highlights', JSON.stringify(saved));
    updateIndicators();
    renderHighlightList();
  }

  function removeHighlight(text) {
    const saved = JSON.parse(localStorage.getItem('highlights') || '[]');
    const updated = saved.filter(item => item.text !== text);
    localStorage.setItem('highlights', JSON.stringify(updated));
    updateIndicators();
    renderHighlightList();
  }

  function updateIndicators() {
    const highlights = JSON.parse(localStorage.getItem('highlights') || '[]');
    const note = localStorage.getItem('pageNote_chapter1');
    highlightAlert.style.display = highlights.length > 0 ? 'block' : 'none';
    notebookIndicator.style.display = note ? 'block' : 'none';
  }

  function renderHighlightList() {
    const container = document.getElementById('highlight-items');
    container.innerHTML = '';
    const highlights = JSON.parse(localStorage.getItem('highlights') || '[]');

    highlights.forEach(item => {
      const wrapper = document.createElement('div');
      wrapper.style.background = item.color;
      wrapper.style.padding = '8px';
      wrapper.style.marginBottom = '6px';
      wrapper.style.borderRadius = '6px';
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
      wrapper.style.gap = '6px';

      const text = document.createElement('div');
      text.textContent = `📍 ${item.text}`;
      text.style.fontWeight = 'bold';

      const note = document.createElement('div');
      note.textContent = item.note ? `📝 ${item.note}` : '📝 لا توجد ملاحظة';

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '10px';

      const speakBtn = document.createElement('button');
      speakBtn.textContent = '🔊';
      speakBtn.style.background = '#4caf50';
      speakBtn.style.color = '#fff';
      speakBtn.style.border = 'none';
      speakBtn.style.padding = '4px 10px';
      speakBtn.style.borderRadius = '6px';
      speakBtn.style.cursor = 'pointer';
      speakBtn.onclick = () => {
        speakText(item.note || item.text);
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '🗑️';
      deleteBtn.style.background = '#ff4081';
      deleteBtn.style.color = '#fff';
      deleteBtn.style.border = 'none';
      deleteBtn.style.padding = '4px 10px';
      deleteBtn.style.borderRadius = '6px';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.onclick = () => {
        removeHighlight(item.text);
        const marks = document.querySelectorAll(`mark[data-text="${item.text}"]`);
marks.forEach(m => {
  const textNode = document.createTextNode(m.getAttribute('data-text'));
  m.replaceWith(textNode);
});
      };

      actions.appendChild(speakBtn);
      actions.appendChild(deleteBtn);
      wrapper.appendChild(text);
      wrapper.appendChild(note);
      wrapper.appendChild(actions);
      container.appendChild(wrapper);
    });

    const listBox = document.getElementById('highlight-list');
    listBox.style.display = highlights.length === 0 ? 'none' : 'block';
  }

  highlightAlert.onclick = () => {
    const list = document.getElementById('highlight-list');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
  };
  // دفتر الملاحظات 📔
  const notebookPanel = document.getElementById('notebook-panel');
  const notebookInput = document.getElementById('notebook-input');

  document.getElementById('tool-notebook').onclick = () => {
    notebookPanel.style.bottom = '0px';
  };

  document.getElementById('save-notebook').onclick = () => {
    const note = notebookInput.value.trim();
    if (note) {
      localStorage.setItem('pageNote_chapter1', note);
      notebookPanel.style.bottom = '-300px';
      updateIndicators();
      alert('✅ تم حفظ الملاحظة!');
    }
  };

  document.getElementById('delete-notebook').onclick = () => {
    localStorage.removeItem('pageNote_chapter1');
    notebookInput.value = '';
    notebookPanel.style.bottom = '-300px';
    updateIndicators();
    alert('🗑️ تم حذف الملاحظة!');
  };

  notebookIndicator.onclick = () => {
    notebookPanel.style.bottom = '0px';
  };

  // الدردشة الذكية 💬
  const chatToggle = document.getElementById('chat-toggle');
  const chatBox = document.getElementById('chatBox');
  const chatBody = document.getElementById('chatBody');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  chatToggle.addEventListener('click', () => {
    chatBox.style.display = chatBox.style.display === 'flex' ? 'none' : 'flex';
    chatBox.style.flexDirection = 'column';
  });

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  function appendMessage(role, content) {
    const msg = document.createElement('div');
    msg.className = 'chat-message ' + role;
    msg.textContent = content;
    msg.style.padding = '8px';
    msg.style.marginBottom = '6px';
    msg.style.borderRadius = '6px';
    msg.style.background = role === 'user' ? '#333' : '#444';
    msg.style.color = '#fdd835';
    chatBody.appendChild(msg);
  }
function toggleZoom(img) {
  // إزالة الزوم من جميع الصور الأخرى
  document.querySelectorAll('.gallery img').forEach(i => {
    if (i !== img) i.classList.remove('zoomed');
  });

  // تبديل الزوم للصورة الحالية
  img.classList.toggle('zoomed');
}
  function updateLastBotMessage(content) {
    const messages = document.querySelectorAll('.chat-message.bot');
    if (messages.length > 0) {
      messages[messages.length - 1].textContent = content;
    }
  }

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    appendMessage('user', text);
    appendMessage('bot', '...جاري التفكير');

    try {
      const response = await fetch('https://gpt-proxy-server-xs5u.onrender.com/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: text })
      });

      const data = await response.json();
      updateLastBotMessage(data.reply);
    } catch {
      updateLastBotMessage('❌ حدث خطأ أثناء الاتصال بالخادم.');
    }

    userInput.value = '';
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // استعادة التظليلات والملاحظات عند تحميل الصفحة
  window.addEventListener('DOMContentLoaded', () => {
    const saved = JSON.parse(localStorage.getItem('highlights') || '[]');
    let html = textBox.innerHTML;
    saved.forEach(item => {
      const mark = `<mark style="background-color:${item.color}" data-note="${item.note}" data-text="${item.text}">${item.text}</mark>`;
      const regex = new RegExp(item.text, 'g');
      html = html.replace(regex, mark);
    });
    textBox.innerHTML = html;

    const savedNote = localStorage.getItem('pageNote_chapter1');
    if (savedNote) notebookInput.value = savedNote;

    updateIndicators();
    renderHighlightList();
  });

  // عرض أدوات التظليل عند الضغط على كلمة مظللة
  textBox.addEventListener('click', e => {
    if (e.target.tagName === 'MARK') {
      const text = e.target.getAttribute('data-text');
      const note = e.target.getAttribute('data-note');
      const rect = e.target.getBoundingClientRect();
      highlightMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
      highlightMenu.style.left = `${rect.left + window.scrollX}px`;
      highlightMenu.style.display = 'block';
      noteInput.value = note;

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '🗑️ حذف التظليل';
      deleteBtn.style.background = '#ff4081';
      deleteBtn.style.color = '#fff';
      deleteBtn.style.border = 'none';
      deleteBtn.style.padding = '6px 12px';
      deleteBtn.style.borderRadius = '6px';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.onclick = () => {
        e.target.remove();
        removeHighlight(text);
        highlightMenu.style.display = 'none';
      };

      const speakBtn = document.createElement('button');
      speakBtn.textContent = '🔊 سماع الملاحظة';
      speakBtn.style.background = '#4caf50';
      speakBtn.style.color = '#fff';
      speakBtn.style.border = 'none';
      speakBtn.style.padding = '6px 12px';
      speakBtn.style.borderRadius = '6px';
      speakBtn.style.cursor = 'pointer';
      speakBtn.onclick = () => {
        speakText(note || text);
      };

      const actionsBox = document.getElementById('highlight-actions');
      actionsBox.innerHTML = '';
      actionsBox.appendChild(deleteBtn);
      actionsBox.appendChild(speakBtn);
    }
  });
</script>
</body>
</html>



