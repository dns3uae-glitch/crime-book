<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>chapter1</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #fdd835;
      direction: rtl;
      overflow-x: hidden;
    }

    header {
      width: 100%;
      height: clamp(60px, 8vh, 70px);
      background-color: #000;
      color: #fdd835;
      text-shadow: 1px 1px 2px black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(18px, 2vw, 22px);
      font-weight: bold;
      letter-spacing: 1px;
      border-top: 4px solid #fdd835;
      border-bottom: 4px solid #fdd835;
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
      position: fixed;
      top: 0;
      z-index: 100;
    }

    .page-wrapper {
      padding-top: clamp(70px, 8vh, 80px);
      padding-bottom: clamp(70px, 8vh, 80px);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }

    .center-box {
      width: 95%;
      max-width: 900px;
      background-color: #222;
      border: 2px solid #fdd835;
      border-radius: 14px;
      box-shadow: 0 0 40px rgba(255, 255, 0, 0.3);
      padding: 40px;
      font-size: 28px;
      line-height: 2;
      text-align: center;
      color: #fff;
    }

    mark {
      background-color: inherit;
      padding: 2px 4px;
      border-radius: 4px;
      cursor: pointer;
    }

    footer {
      width: 100%;
      height: clamp(60px, 8vh, 70px);
      background-color: #000;
      border-top: 4px solid #fdd835;
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
      position: fixed;
      bottom: 0;
      z-index: 100;
    }

    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
      padding: 0 20px;
    }

    .nav-left, .nav-right, .nav-center {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-button {
      background-color: #222;
      color: #fdd835;
      border: 2px solid #fdd835;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      transition: 0.3s;
    }

    .nav-button:hover {
      background-color: rgba(255,255,0,0.2);
      transform: scale(1.05);
    }

    #footer-indicators button {
      background: #fdd835;
      color: #000;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(255,255,0,0.3);
      display: none;
    }
  </style>
</head>
<body>
  <header>📘 الفصل الأول</header>

  <div class="page-wrapper">
   <style>
    body { font-family: 'Segoe UI'; direction: rtl; background: #111; padding: 20px; }
    .box { background: #111; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; margin-bottom: 20px; }
    .timer { font-size: 20px; color: #4da6ff; margin-bottom: 10px; font-weight: bold; }
    button { background: #4da6ff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin: 5px; }
    button:hover { background: #3399ff; }
    .dropzone {
      display: inline-block;
      width: 140px;
      height: 30px;
      border: 2px dashed #aaa;
      margin: 0 5px;
      vertical-align: middle;
      text-align: center;
      line-height: 30px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    .word {
      display: inline-block;
      padding: 8px 12px;
      margin: 5px;
      background: #4da6ff;
      color: white;
      border-radius: 6px;
      cursor: grab;
    }
    .word.dragging { opacity: 0.5; }
    .choice-img {
      width: 150px;
      height: auto;
      border: 3px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    .choice-img:hover {
      transform: scale(1.05);
    }
    .choice-img.selected {
      border-color: #4da6ff;
    }
  </style>
</head>
<body>

<audio id="alertSound" src="https://downloadwap.com/content2/mp3-ringtones/tone/2020/sound-fx/preview/8ba332c85141038.mp3"></audio>

<div class="box" id="introBox">
  <h2>🕒 تجربة زمنية: اليد الخفية</h2>
  <p>عزيزي الطالب الظابط ستقوم بقراءة السيناريو خلال <strong>60 ثانية</strong>، ثم تظهر لك الأسئلة ويكون لديك <strong>30 ثانية</strong> للإجابة.</p>
  <button onclick="startScenario()">ابدأ</button>
</div>

<div class="box" id="scenarioBox" style="display:none;">
  <div class="timer" id="scenarioTimer">الوقت المتبقي: 60 ثانية</div>
  <h3>📂 القضية: "اليد الخفية"</h3>
  <p>
    في مساء يوم الجمعة، أقيمت حفلة خاصة داخل شقة فاخرة في مويلح الشارقة لرجل أعمال معروف يُدعى <strong>الخبير الدكتور أحمد صابر</strong>. الشقة كانت مزينة بأضواء خافتة وموسيقى كلاسيكية، والضيوف كانوا محدودين:<br><br>
    - <strong>عبدالله</strong>: خبير نفسي، كان يضحك كثيرًا لكنه يخفي توترًا واضحًا.<br>
    - <strong>جمال</strong>: شريك أعمال سابق، جلس في الزاوية يراقب بصمت.<br>
    - <strong>صفاء</strong>: صديق قديم، غادر قبل منتصف الليل دون أن يودّع أحد.<br><br>
    في تمام الساعة <strong>منتصف الليل</strong>، اختفى أحمد صابر من الفيلا. وُجدت رسالة غامضة على البيانو تقول: <em>"من يضحك أولًا... لا يضحك أخيرًا."</em><br><br>
    تم العثور على كأس مكسور قرب الباب الخلفي، وبصمة غير معروفة على مقبض النافذة. عبدالله أنكر معرفته بما حدث، لكن عينية كانت ترتجف. جمال قال إنه لم يغادر الزاوية طوال الوقت، بينما صفاء لم يُجب على هاتفه حتى الآن.<br><br>
    التحقيق بدأ، والشكوك تدور حول تصرفات الضيوف الثلاثة. من منهم كان يعرف أن أحمد صابر يخبئ شيئًا؟ ومن منهم كان مستعدًا لاختفائه؟
  </p>
  <button onclick="endScenarioEarly()">انتهيت من القراءة</button>
</div>

<div class="box" id="quizBox" style="display:none;">
  <div class="timer" id="quizTimer">الوقت المتبقي: 30 ثانية</div>
  <h3>🧠 أكمل تقرير المحقق بسحب الكلمات:</h3>
  <p>
    في تمام الساعة <span class="dropzone" data-answer="منتصف الليل"></span>، غادر صفاء الفيلا دون أن <span class="dropzone" data-answer="يودّع"></span> أحد.  
    عبدالله كان <span class="dropzone" data-answer="يضحك"></span> لكنه يخفي توترًا واضحًا.
  </p>
  <h4>🧩 الكلمات المتاحة:</h4>
  <div id="words">
    <span class="word" draggable="true">منتصف الليل</span>
    <span class="word" draggable="true">يودّع</span>
    <span class="word" draggable="true">يضحك</span>
    <span class="word" draggable="true">يصرخ</span>
    <span class="word" draggable="true">يختفي</span>
  </div>
  <button onclick="checkAnswers()">📊 تحقق من الإجابات</button>
  <div id="result" style="margin-top: 15px; font-size: 18px;"></div>
</div>

<div class="box" id="startSecondBox" style="display:none;">
  <h3>🔍 عزيزي الطالب الضابط هل أنت مستعد للمرحلة الثانية؟</h3>
  <p>اقرأ السيناريو الجديد خلال <strong>45 ثانية</strong>، ثم اختر الصورة التي تمثل الدليل الأكثر غموضًا.</p>
  <button onclick="startSecondScenario()">ابدأ المرحلة الثانية</button>
</div>

<div class="box" id="secondScenarioBox" style="display:none;">
  <div class="timer" id="secondScenarioTimer">الوقت المتبقي: 45 ثانية</div>
  <h3>🎼 القضية الثانية: "البيانو الأخير"</h3>
  <p>
    في ليلة هادئة داخل قاعة موسيقية قديمة، كان العازف الشهير <strong>أبو سيف</strong> يستعد لعزف مقطوعته الأخيرة قبل الاعتزال.<br><br>
    الجمهور كان محدودًا، والمكان مضاء بأضواء خافتة تنعكس على مفاتيح البيانو الأسود.<br>
    قبل بدء العزف، دخلت امرأة مجهولة وجلست في الصف الأخير، ثم غادرت بعد دقائق دون أن يتحدث إليها أحد.<br><br>
    بعد انتهاء المقطوعة، اختفى أبو سيف من القاعة، وترك خلفه ثلاثة أشياء فقط:<br>
    - كأس مكسور على الأرض قرب البيانو<br>
    - بصمة غير معروفة على غطاء البيانو<br>
    - رسالة مكتوبة بخط يده تقول: <em>"حين تصمت الموسيقى، يبدأ التحقيق."</em><br><br>
    لم يُعثر على أبو سيف حتى الآن، والتحقيق بدأ من هذه الأدلة الثلاثة.
  </p>
  <button onclick="endSecondScenarioEarly()">انتهيت من القراءة</button>
</div>

<div class="box" id="imageChoiceBox" style="display:none;">
  <h3>🕵️‍♂️ أي من هذه الأيقونات تمثل الدليل الأكثر غموضًا؟</h3>
  <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTI_KD85hNp_CO6YxsTn8n6HZuOvKQxrpxbSm81udLn1ME6L0-zWJhosK8&s" alt="كأس مكسور" class="choice-img" data-answer="false">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/%D8%A8%D8%B5%D9%85%D8%A9_%D8%A7%D8%B5%D8%A8%D8%B9.webp/500px-%D8%A8%D8%B5%D9%85%D8%A9_%D8%A7%D8%B5%D8%A8%D8%B9.webp.png" alt="بصمة" class="choice-img" data-answer="true">
    <img src="https://png.pngtree.com/png-clipart/20250107/original/pngtree-note-paper-for-musical-notes-message-stave-barrel-textured-png-image_9676833.png" alt="رسالة على البيانو" class="choice-img" data-answer="false">
  </div>
  <button onclick="checkImageChoice()">📊 تحقق من اختيارك</button>
  <div id="imageResult" style="margin-top:15px; font-size:18px;"></div>
</div>


<script>
let scenarioTime = 60;
let quizTime = 30;
let secondScenarioTime = 45;
let scenarioInterval, quizInterval, secondScenarioInterval;
let alertPlayed = false;
let alertSound = document.getElementById("alertSound");
const wordBank = document.getElementById("words");

function setupDragAndDrop() {
  const words = document.querySelectorAll('.word');
  const zones = document.querySelectorAll('.dropzone');

  words.forEach(word => {
    word.addEventListener('dragstart', () => word.classList.add('dragging'));
    word.addEventListener('dragend', () => word.classList.remove('dragging'));
  });

  zones.forEach(zone => {
    zone.addEventListener('dragover', e => e.preventDefault());
    zone.addEventListener('drop', e => {
      const dragged = document.querySelector('.dragging');
      if (dragged) {
        const previous = zone.getAttribute('data-user');
        if (previous) {
          const returned = document.createElement("span");
          returned.className = "word";
          returned.textContent = previous;
          returned.setAttribute("draggable", "true");
          returned.addEventListener('dragstart', () => returned.classList.add('dragging'));
          returned.addEventListener('dragend', () => returned.classList.remove('dragging'));
          wordBank.appendChild(returned);
        }
        zone.textContent = dragged.textContent;
        zone.setAttribute('data-user', dragged.textContent);
        dragged.remove();
        zone.style.border = '2px dashed #aaa';
      }
    });
  });
}

function startScenario() {
  document.getElementById("introBox").style.display = "none";
  document.getElementById("scenarioBox").style.display = "block";
  updateTimer("scenarioTimer", scenarioTime);
  scenarioInterval = setInterval(() => {
    scenarioTime--;
    updateTimer("scenarioTimer", scenarioTime);
    if (scenarioTime <= 0) {
      clearInterval(scenarioInterval);
      showQuiz();
    }
  }, 1000);
}

function endScenarioEarly() {
  clearInterval(scenarioInterval);
  showQuiz();
}

function showQuiz() {
  document.getElementById("scenarioBox").style.display = "none";
  document.getElementById("quizBox").style.display = "block";
  setupDragAndDrop();
  startQuizTimer();
}

function startQuizTimer() {
  updateTimer("quizTimer", quizTime);
  quizInterval = setInterval(() => {
    quizTime--;
    updateTimer("quizTimer", quizTime);
    if (quizTime === 5 && !alertPlayed) {
      alertSound.play();
      alertPlayed = true;
    }
    if (quizTime <= 0) {
      clearInterval(quizInterval);
      document.getElementById("quizTimer").innerText = "⏱ انتهى الوقت!";
    }
  }, 1000);
}

function updateTimer(id, time) {
  document.getElementById(id).innerText = "الوقت المتبقي: " + time + " ثانية";
}

function checkAnswers() {
  const zones = document.querySelectorAll('.dropzone');
  let correct = 0;
  let incorrect = 0;

  zones.forEach(zone => {
    const user = zone.getAttribute('data-user');
    const answer = zone.getAttribute('data-answer');
    if (user === answer) {
      zone.style.border = '2px solid green';
      correct++;
    } else {
      zone.style.border = '2px solid red';
      if (user) {
        const returned = document.createElement("span");
        returned.className = "word";
        returned.textContent = user;
        returned.setAttribute("draggable", "true");
        returned.addEventListener('dragstart', () => returned.classList.add('dragging'));
        returned.addEventListener('dragend', () => returned.classList.remove('dragging'));
        wordBank.appendChild(returned);
      }
      zone.textContent = "";
      zone.removeAttribute("data-user");
      incorrect++;
    }
  });

  const r = document.getElementById("result");
  if (incorrect === 0 && correct === zones.length) {
    clearInterval(quizInterval);
    document.getElementById("quizTimer").innerText = "✅ انتهت المهمة بنجاح!";
    r.innerHTML = "✅ ممتاز! أكملت تقرير التحقيق بدقة. انتقل الآن إلى المرحلة الثانية.";
    r.style.color = "green";
    setTimeout(showSecondIntro, 2000);
  } else {
    r.innerHTML = "❌ هناك أخطاء في التقرير. تم إعادة الكلمات الخاطئة، يمكنك تعديلها وإعادة المحاولة.";
    r.style.color = "red";
  }
}

function showSecondIntro() {
  document.getElementById("quizBox").style.display = "none";
  document.getElementById("startSecondBox").style.display = "block";
}

function startSecondScenario() {
  document.getElementById("startSecondBox").style.display = "none";
  document.getElementById("secondScenarioBox").style.display = "block";
  updateTimer("secondScenarioTimer", secondScenarioTime);
  secondScenarioInterval = setInterval(() => {
    secondScenarioTime--;
    updateTimer("secondScenarioTimer", secondScenarioTime);
    if (secondScenarioTime <= 0) {
      clearInterval(secondScenarioInterval);
      showImageChoice();
    }
  }, 1000);
}

function endSecondScenarioEarly() {
  clearInterval(secondScenarioInterval);
  showImageChoice();
}

function showImageChoice() {
  document.getElementById("secondScenarioBox").style.display = "none";
  document.getElementById("imageChoiceBox").style.display = "block";
}

let selectedImage = null;

document.querySelectorAll('.choice-img').forEach(img => {
  img.addEventListener('click', () => {
    document.querySelectorAll('.choice-img').forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
    selectedImage = img.getAttribute('data-answer');
  });
});

function checkImageChoice() {
  const result = document.getElementById("imageResult");
  if (selectedImage === "true") {
    result.innerHTML = "✅ اختيار صحيح! البصمة تشير إلى وجود طرف ثالث.";
    result.style.color = "green";
  } else if (selectedImage === "false") {
    result.innerHTML = "❌ اختيار غير دقيق. حاول التفكير في الدليل الذي لا ينتمي لأي من الحاضرين.";
    result.style.color = "red";
  } else {
    result.innerHTML = "⚠️ الرجاء اختيار صورة أولاً.";
    result.style.color = "orange";
  }
}
</script>

  </div>

  <footer>
    <div class="footer-content">
      <div class="nav-left">
        <button class="nav-button" onclick="goToPrevious()">⬅️ السابق</button>
      </div>
      <div class="nav-center" id="footer-indicators">
        <button id="highlight-alert">📌 كلمات مظللة</button>
        <button id="notebook-indicator">📔 ملاحظة محفوظة</button>
      </div>
      <div class="nav-right">
        <button class="nav-button" onclick="goToNext()">➡️ التالي</button>
      </div>
    </div>
  </footer>
<!-- قائمة الأدوات العائمة -->
<div id="tool-menu" style="display:none; position:absolute; background:#222; border:2px solid #fdd835; padding:10px; border-radius:8px; z-index:1000; display:flex; gap:10px;">
  <button id="tool-highlight">✏️</button>
  <button id="tool-search">🔍</button>
  <button id="tool-speak">🔊</button>
  <button id="tool-notebook">📔</button>
</div>

<!-- قائمة التظليل والملاحظة -->
<div id="highlight-menu" style="display:none; position:absolute; background:#222; border:2px solid #fdd835; padding:10px; border-radius:8px; z-index:1000; width:280px;" onclick="event.stopPropagation();">
  <div class="colors" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-bottom:10px;">
    <span class="color" data-color="#fdd835" style="background:#fdd835; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#ff4081" style="background:#ff4081; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#40c4ff" style="background:#40c4ff; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#4caf50" style="background:#4caf50; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#ff9800" style="background:#ff9800; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#9c27b0" style="background:#9c27b0; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#00bcd4" style="background:#00bcd4; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#795548" style="background:#795548; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#e91e63" style="background:#e91e63; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
    <span class="color" data-color="#8bc34a" style="background:#8bc34a; width:24px; height:24px; border-radius:50%; cursor:pointer;"></span>
  </div>
  <textarea id="note-input" placeholder="اكتب ملاحظة هنا..." style="width:100%; height:60px; font-size:16px; padding:8px; resize:vertical; border-radius:6px; border:1px solid #fdd835; background:#fff; color:#000;" onclick="event.stopPropagation();"></textarea>
  <div id="highlight-actions" style="margin-top:10px; display:flex; gap:10px;"></div>
</div>

<!-- دفتر الملاحظات -->
<div id="notebook-panel" style="position:fixed; bottom:-300px; left:50%; transform:translateX(-50%); width:90%; max-width:600px; background:#222; border:2px solid #fdd835; border-radius:12px 12px 0 0; padding:20px; box-shadow:0 -4px 20px rgba(255,255,0,0.3); transition:bottom 0.4s ease; z-index:9999; color:#fff; text-align:center;">
  <h3 style="margin-top:0;">📔 ملاحظات عامة عن الصفحة</h3>
  <textarea id="notebook-input" placeholder="اكتب ملاحظتك هنا..." style="width:100%; height:100px; font-size:16px; padding:10px; border-radius:6px; border:1px solid #fdd835; resize:vertical; margin-top:10px; background:#fff; color:#000;"></textarea>
  <div style="display:flex; justify-content:center; gap:12px; margin-top:12px;">
    <button id="save-notebook" style="background:#4caf50; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">💾 حفظ</button>
    <button id="delete-notebook" style="background:#ff4081; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">🗑️ حذف</button>
  </div>
</div>

<!-- قائمة التظليلات المحفوظة -->
<div id="highlight-list" style="display:none; position:fixed; bottom:80px; left:20px; width:300px; max-height:300px; overflow-y:auto; background:#222; border:2px solid #fdd835; border-radius:12px; padding:10px; box-shadow:0 0 20px rgba(255,255,0,0.3); z-index:9999; color:#fff;">
  <h3 style="margin-top:0;">📌 الكلمات المظللة</h3>
  <div id="highlight-items"></div>
</div>

<!-- زر فتح الدردشة -->
<button id="chat-toggle" style="background:#fdd835; color:#000; border:none; border-radius:50%; width:55px; height:55px; font-size:26px; cursor:pointer; position:fixed; bottom:90px; right:20px; box-shadow:0 0 10px rgba(255,255,0,0.5); z-index:1201;">💬</button>

<!-- نافذة الدردشة -->
<div class="chat-container" id="chatBox" style="position:fixed; bottom:160px; right:20px; max-width:400px; background:#222; border:2px solid #fdd835; border-radius:12px; box-shadow:0 0 20px rgba(255,255,0,0.3); display:none; flex-direction:column; overflow:hidden; z-index:1202;">
  <div class="chat-header" style="background:#000; color:#fdd835; padding:12px; font-size:18px; text-align:center; border-bottom:2px solid #fdd835;">مساعدك الذكي</div>
  <div class="chat-body" id="chatBody" style="padding:10px; height:250px; overflow-y:auto; background:#111;"></div>
  <div class="chat-footer" style="display:flex; padding:10px; border-top:1px solid #fdd835; background:#000;">
    <input type="text" id="userInput" placeholder="اكتب سؤالك هنا..." style="flex:1; padding:8px; border:none; border-radius:5px; font-size:14px; background:#222; color:#fff;">
    <button id="sendBtn" style="background:#fdd835; color:#000; border:none; padding:8px 12px; margin-left:8px; border-radius:5px; cursor:pointer; font-weight:bold;">إرسال</button>
  </div>
</div>
<script>
  function goToPrevious() {
    window.location.href = 'https://dns3uae-glitch.github.io/crime-book/select';
  }

  function goToNext() {
    window.location.href = 'https://dns3uae-glitch.github.io/crime-book/11';
  }

  function getEmiratiMaleVoice() {
    const voices = speechSynthesis.getVoices();
    return voices.find(v => v.lang === 'ar-AE' && v.name.toLowerCase().includes('male')) ||
           voices.find(v => v.lang === 'ar-AE') ||
           voices.find(v => v.lang.includes('ar') && v.name.toLowerCase().includes('male')) ||
           voices.find(v => v.lang.includes('ar')) ||
           voices.find(v => v.lang.includes('en')) ||
           voices[0];
  }

  function speakText(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    const voice = getEmiratiMaleVoice();
    if (voice) {
      utterance.voice = voice;
      utterance.lang = voice.lang;
    }
    speechSynthesis.cancel();
    setTimeout(() => {
      speechSynthesis.speak(utterance);
    }, 100);
  }
let voicesReady = false;
speechSynthesis.onvoiceschanged = () => {
  voicesReady = true;
};

  const toolMenu = document.getElementById('tool-menu');
  const highlightMenu = document.getElementById('highlight-menu');
  const noteInput = document.getElementById('note-input');
  const highlightAlert = document.getElementById('highlight-alert');
  const notebookIndicator = document.getElementById('notebook-indicator');
  const textBox = document.getElementById('text-box');
  let selectedText = '';
  let selectedRange = null;

  document.addEventListener('mouseup', (e) => {
  if (e.target.closest('#highlight-menu')) return;

  const selection = window.getSelection();
  if (selection.toString().trim().length > 0) {
    selectedText = selection.toString();
    selectedRange = selection.getRangeAt(0);
    const rect = selectedRange.getBoundingClientRect();
    toolMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
    toolMenu.style.left = `${rect.left + window.scrollX}px`;
    toolMenu.style.display = 'flex';
    highlightMenu.style.display = 'none';
  } else {
    toolMenu.style.display = 'none';
    highlightMenu.style.display = 'none';
  }
});


  document.getElementById('tool-highlight').onclick = () => {
    highlightMenu.style.top = toolMenu.style.top;
    highlightMenu.style.left = toolMenu.style.left;
    highlightMenu.style.display = 'block';
    toolMenu.style.display = 'none';
  };

  document.getElementById('tool-search').onclick = () => {
    if (selectedText.trim()) {
     const query = encodeURIComponent(selectedText.trim());
window.open(
  `https://www.google.com/search?q=${query}`,
  'popupWindow',
  'width=800,height=600,top=100,left=200'
);


    }
  };
document.getElementById('tool-speak').onclick = () => {
  if (selectedText.trim()) {
    speakText(selectedText.trim());
    toolMenu.style.display = 'none';
  }
};

  document.querySelectorAll('.color').forEach(colorBtn => {
    colorBtn.addEventListener('click', () => {
      const color = colorBtn.getAttribute('data-color');
      const note = noteInput.value.trim();
      const mark = document.createElement('mark');
      mark.textContent = selectedText;
      mark.style.backgroundColor = color;
      mark.setAttribute('data-note', note);
      mark.setAttribute('data-text', selectedText);
      selectedRange.deleteContents();
      selectedRange.insertNode(mark);
      saveHighlight(selectedText, color, note);
      highlightMenu.style.display = 'none';
      noteInput.value = '';
    });
  });

  function saveHighlight(text, color, note) {
    const saved = JSON.parse(localStorage.getItem('highlights') || '[]');
    saved.push({ text, color, note });
    localStorage.setItem('highlights', JSON.stringify(saved));
    updateIndicators();
    renderHighlightList();
  }

  function removeHighlight(text) {
    const saved = JSON.parse(localStorage.getItem('highlights') || '[]');
    const updated = saved.filter(item => item.text !== text);
    localStorage.setItem('highlights', JSON.stringify(updated));
    updateIndicators();
    renderHighlightList();
  }

  function updateIndicators() {
    const highlights = JSON.parse(localStorage.getItem('highlights') || '[]');
    const note = localStorage.getItem('pageNote_chapter1');
    highlightAlert.style.display = highlights.length > 0 ? 'block' : 'none';
    notebookIndicator.style.display = note ? 'block' : 'none';
  }

  function renderHighlightList() {
    const container = document.getElementById('highlight-items');
    container.innerHTML = '';
    const highlights = JSON.parse(localStorage.getItem('highlights') || '[]');

    highlights.forEach(item => {
      const wrapper = document.createElement('div');
      wrapper.style.background = item.color;
      wrapper.style.padding = '8px';
      wrapper.style.marginBottom = '6px';
      wrapper.style.borderRadius = '6px';
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
      wrapper.style.gap = '6px';

      const text = document.createElement('div');
      text.textContent = `📍 ${item.text}`;
      text.style.fontWeight = 'bold';

      const note = document.createElement('div');
      note.textContent = item.note ? `📝 ${item.note}` : '📝 لا توجد ملاحظة';

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '10px';

      const speakBtn = document.createElement('button');
      speakBtn.textContent = '🔊';
      speakBtn.style.background = '#4caf50';
      speakBtn.style.color = '#fff';
      speakBtn.style.border = 'none';
      speakBtn.style.padding = '4px 10px';
      speakBtn.style.borderRadius = '6px';
      speakBtn.style.cursor = 'pointer';
      speakBtn.onclick = () => {
        speakText(item.note || item.text);
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '🗑️';
      deleteBtn.style.background = '#ff4081';
      deleteBtn.style.color = '#fff';
      deleteBtn.style.border = 'none';
      deleteBtn.style.padding = '4px 10px';
      deleteBtn.style.borderRadius = '6px';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.onclick = () => {
        removeHighlight(item.text);
        const marks = document.querySelectorAll(`mark[data-text="${item.text}"]`);
marks.forEach(m => {
  const textNode = document.createTextNode(m.getAttribute('data-text'));
  m.replaceWith(textNode);
});
      };

      actions.appendChild(speakBtn);
      actions.appendChild(deleteBtn);
      wrapper.appendChild(text);
      wrapper.appendChild(note);
      wrapper.appendChild(actions);
      container.appendChild(wrapper);
    });

    const listBox = document.getElementById('highlight-list');
    listBox.style.display = highlights.length === 0 ? 'none' : 'block';
  }

  highlightAlert.onclick = () => {
    const list = document.getElementById('highlight-list');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
  };
  // دفتر الملاحظات 📔
  const notebookPanel = document.getElementById('notebook-panel');
  const notebookInput = document.getElementById('notebook-input');

  document.getElementById('tool-notebook').onclick = () => {
    notebookPanel.style.bottom = '0px';
  };

  document.getElementById('save-notebook').onclick = () => {
    const note = notebookInput.value.trim();
    if (note) {
      localStorage.setItem('pageNote_chapter1', note);
      notebookPanel.style.bottom = '-300px';
      updateIndicators();
      alert('✅ تم حفظ الملاحظة!');
    }
  };

  document.getElementById('delete-notebook').onclick = () => {
    localStorage.removeItem('pageNote_chapter1');
    notebookInput.value = '';
    notebookPanel.style.bottom = '-300px';
    updateIndicators();
    alert('🗑️ تم حذف الملاحظة!');
  };

  notebookIndicator.onclick = () => {
    notebookPanel.style.bottom = '0px';
  };

  // الدردشة الذكية 💬
  const chatToggle = document.getElementById('chat-toggle');
  const chatBox = document.getElementById('chatBox');
  const chatBody = document.getElementById('chatBody');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  chatToggle.addEventListener('click', () => {
    chatBox.style.display = chatBox.style.display === 'flex' ? 'none' : 'flex';
    chatBox.style.flexDirection = 'column';
  });

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  function appendMessage(role, content) {
    const msg = document.createElement('div');
    msg.className = 'chat-message ' + role;
    msg.textContent = content;
    msg.style.padding = '8px';
    msg.style.marginBottom = '6px';
    msg.style.borderRadius = '6px';
    msg.style.background = role === 'user' ? '#333' : '#444';
    msg.style.color = '#fdd835';
    chatBody.appendChild(msg);
  }

  function updateLastBotMessage(content) {
    const messages = document.querySelectorAll('.chat-message.bot');
    if (messages.length > 0) {
      messages[messages.length - 1].textContent = content;
    }
  }

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    appendMessage('user', text);
    appendMessage('bot', '...جاري التفكير');

    try {
      const response = await fetch('https://gpt-proxy-server-xs5u.onrender.com/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: text })
      });

      const data = await response.json();
      updateLastBotMessage(data.reply);
    } catch {
      updateLastBotMessage('❌ حدث خطأ أثناء الاتصال بالخادم.');
    }

    userInput.value = '';
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // استعادة التظليلات والملاحظات عند تحميل الصفحة
  window.addEventListener('DOMContentLoaded', () => {
    const saved = JSON.parse(localStorage.getItem('highlights') || '[]');
    let html = textBox.innerHTML;
    saved.forEach(item => {
      const mark = `<mark style="background-color:${item.color}" data-note="${item.note}" data-text="${item.text}">${item.text}</mark>`;
      const regex = new RegExp(item.text, 'g');
      html = html.replace(regex, mark);
    });
    textBox.innerHTML = html;

    const savedNote = localStorage.getItem('pageNote_chapter1');
    if (savedNote) notebookInput.value = savedNote;

    updateIndicators();
    renderHighlightList();
  });

  // عرض أدوات التظليل عند الضغط على كلمة مظللة
  textBox.addEventListener('click', e => {
    if (e.target.tagName === 'MARK') {
      const text = e.target.getAttribute('data-text');
      const note = e.target.getAttribute('data-note');
      const rect = e.target.getBoundingClientRect();
      highlightMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
      highlightMenu.style.left = `${rect.left + window.scrollX}px`;
      highlightMenu.style.display = 'block';
      noteInput.value = note;

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '🗑️ حذف التظليل';
      deleteBtn.style.background = '#ff4081';
      deleteBtn.style.color = '#fff';
      deleteBtn.style.border = 'none';
      deleteBtn.style.padding = '6px 12px';
      deleteBtn.style.borderRadius = '6px';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.onclick = () => {
        e.target.remove();
        removeHighlight(text);
        highlightMenu.style.display = 'none';
      };

      const speakBtn = document.createElement('button');
      speakBtn.textContent = '🔊 سماع الملاحظة';
      speakBtn.style.background = '#4caf50';
      speakBtn.style.color = '#fff';
      speakBtn.style.border = 'none';
      speakBtn.style.padding = '6px 12px';
      speakBtn.style.borderRadius = '6px';
      speakBtn.style.cursor = 'pointer';
      speakBtn.onclick = () => {
        speakText(note || text);
      };

      const actionsBox = document.getElementById('highlight-actions');
      actionsBox.innerHTML = '';
      actionsBox.appendChild(deleteBtn);
      actionsBox.appendChild(speakBtn);
    }
  });
</script>
</body>
</html>





